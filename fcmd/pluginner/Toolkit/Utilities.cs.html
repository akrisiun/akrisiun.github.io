<!DOCTYPE html>
<html><head><title>Utilities.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(496);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#pluginner/Toolkit/Utilities.cs" target="_top">Toolkit\Utilities.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#pluginner" target="_top">fcmd\pluginner\pluginner.csproj</a> (pluginner)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">/* The File Commander - plugin API
 * FC &amp; FC plugin utility set
 * (C) The File Commander Team - https://github.com/atauenis/fcmd
 * (C) 2013-14, Alexander Tauenis (atauenis@yandex.ru)
 * Contributors should place own signs here.
 */</span>

<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Drawing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Reflection</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Runtime</span>.<span class="i n">InteropServices</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Win32</span>;
<b>using</b> <span class="i n">Xwt</span>;
<b>using</b> <span class="i n">Xwt</span>.<span class="i n">Drawing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<span class="c">// using Application = System.Windows.Forms.Application;</span>
<b>using</b> <span class="t">Color</span> = <span class="i n">Xwt</span>.<span class="i n">Drawing</span>.<a href="/Xwt3/A.html#773e78572598ea91" class="t t">Color</a>;
<b>using</b> <span class="t">Image</span> = <span class="i n">Xwt</span>.<span class="i n">Drawing</span>.<a href="/Xwt3/A.html#0e6b2faf07047267" class="t t">Image</a>;

<b>namespace</b> <span class="i n">pluginner</span>.<span class="i n">Toolkit</span>
{
	<b>public static class</b> <a id="5fd4a8de29bac7e7" href="../R/5fd4a8de29bac7e7.html" target="n" data-glyph="0,0" class="t t">Utilities</a>
	{
		<b>static string</b> <a id="7f93071e86196721" href="../R/7f93071e86196721.html" target="n" data-glyph="46,1" class="i field">PathToIcons</a> = <span class="c">//  Application.StartupPath </span>
            <span class="i n">System</span>.<a href="@0@mscorlib/A.html#2e9e7922eace2be8" class="t t">AppDomain</a>.<a href="@0@mscorlib/A.html#0f1cf66beffbb219" class="i property">CurrentDomain</a>.<a href="@0@mscorlib/A.html#694882fc5fb59a81" class="i property">BaseDirectory</a> + <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#d1bb57592858d485" class="i field">DirectorySeparatorChar</a> + <span class="s">&quot;icons&quot;</span>;

		<b>static</b> <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<b>string</b>, <a href="/Xwt3/A.html#0e6b2faf07047267" class="t t">Image</a>&gt; <a id="e5040e784f12008b" href="../R/e5040e784f12008b.html" target="n" data-glyph="46,1" class="i field">cached_images</a> = <b>new</b> <a href="@0@mscorlib/A.html#bf6849e410b43c4c" class="t constructor">Dictionary</a>&lt;<b>string</b>, <a href="/Xwt3/A.html#0e6b2faf07047267" class="t t">Image</a>&gt;();

		<b>static</b> <a href="/Xwt3/A.html#0e6b2faf07047267" class="t t">Image</a> <a id="09296b17d80c5c15" href="../R/09296b17d80c5c15.html" target="n" data-glyph="76,1" class="i method">GetLocalIcon</a>(<b>string</b> <span id="r0 rd" class="r0 r">path</span>) {
            <b>try</b> {
                <b>if</b> (!<a href="#e5040e784f12008b" class="i field">cached_images</a>.<a href="@0@mscorlib/A.html#22fd7cd7408aed6e" class="i method">ContainsKey</a>(<span class="r0 r">path</span>)) {
                    <a href="#e5040e784f12008b" class="i field">cached_images</a><a href="@0@mscorlib/A.html#49962975508e2d83">[</a><span class="r0 r">path</span>] = <a href="/Xwt3/A.html#0e6b2faf07047267" class="t t">Image</a>.<a href="/Xwt3/A.html#c120d96e5b046a5f" class="i method">FromResource</a>(<span class="r0 r">path</span>);
                }
            } <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a>) { <b>return null</b>; }
			<b>return</b> <a href="#e5040e784f12008b" class="i field">cached_images</a><a href="@0@mscorlib/A.html#49962975508e2d83">[</a><span class="r0 r">path</span>];
		}

		<span class="c">//These functions is partially equivalents of the Xwt.MessageDialog ones</span>
		<span class="c">//but they works at UI thread and in fact are macros.</span>
		<span class="c">//Why C# hasn&#39;t macro-templates while the stupid C++ has?</span>
		<b>public static void</b> <a id="4154e45402c4c380" href="../R/4154e45402c4c380.html" target="n" data-glyph="72,1" class="i method">ShowMessage</a>(<b>string</b> <span id="r1 rd" class="r1 r">msg1</span>, <b>string</b> <span id="r2 rd" class="r2 r">msg2</span> = <b>null</b>)
		{
			<span class="i n">Xwt</span>.<a href="/Xwt3/A.html#687215caac5b1b53" class="t t">Application</a>.<a href="/Xwt3/A.html#19c640ba41a65ffb" class="i method">Invoke</a>(<b>delegate</b>{
				<b>if</b> (<span class="r2 r">msg2</span> == <b>null</b>)
					<a href="/Xwt3/A.html#1e0854feacd0db6d" class="t t">MessageDialog</a>.<a href="/Xwt3/A.html#c530d5f1b7afc40b" class="i method">ShowMessage</a>(<span class="r1 r">msg1</span>);
				<b>else</b>
					<a href="/Xwt3/A.html#1e0854feacd0db6d" class="t t">MessageDialog</a>.<a href="/Xwt3/A.html#34b8719ea85315b8" class="i method">ShowMessage</a>(<span class="r1 r">msg1</span>,<span class="r2 r">msg2</span>);
			});
		}

		<b>public static void</b> <a id="1e3ec4228b37652e" href="../R/1e3ec4228b37652e.html" target="n" data-glyph="72,1" class="i method">ShowError</a>(<b>string</b> <span id="r3 rd" class="r3 r">msg1</span>, <b>string</b> <span id="r4 rd" class="r4 r">msg2</span> = <b>null</b>)
		{
			<span class="i n">Xwt</span>.<a href="/Xwt3/A.html#687215caac5b1b53" class="t t">Application</a>.<a href="/Xwt3/A.html#19c640ba41a65ffb" class="i method">Invoke</a>(<b>delegate</b>{
				<b>if</b> (<span class="r4 r">msg2</span> == <b>null</b>)
					<a href="/Xwt3/A.html#1e0854feacd0db6d" class="t t">MessageDialog</a>.<a href="/Xwt3/A.html#ba9a70d0bbf9c51f" class="i method">ShowError</a>(<span class="r3 r">msg1</span>);
				<b>else</b>
					<a href="/Xwt3/A.html#1e0854feacd0db6d" class="t t">MessageDialog</a>.<a href="/Xwt3/A.html#fb07c548b94f2629" class="i method">ShowError</a>(<span class="r3 r">msg1</span>,<span class="r4 r">msg2</span>);
			});
		}

		<b>public static void</b> <a id="facc1883cefcdb12" href="../R/facc1883cefcdb12.html" target="n" data-glyph="72,1" class="i method">ShowWarning</a>(<b>string</b> <span id="r5 rd" class="r5 r">msg1</span>, <b>string</b> <span id="r6 rd" class="r6 r">msg2</span> = <b>null</b>)
		{
			<span class="i n">Xwt</span>.<a href="/Xwt3/A.html#687215caac5b1b53" class="t t">Application</a>.<a href="/Xwt3/A.html#19c640ba41a65ffb" class="i method">Invoke</a>(<b>delegate</b>{
				<b>if</b> (<span class="r6 r">msg2</span> == <b>null</b>)
					<a href="/Xwt3/A.html#1e0854feacd0db6d" class="t t">MessageDialog</a>.<a href="/Xwt3/A.html#f9765707d4c04b4a" class="i method">ShowWarning</a>(<span class="r5 r">msg1</span>);
				<b>else</b>
					<a href="/Xwt3/A.html#1e0854feacd0db6d" class="t t">MessageDialog</a>.<a href="/Xwt3/A.html#345b746b6874b51e" class="i method">ShowWarning</a>(<span class="r5 r">msg1</span>,<span class="r6 r">msg2</span>);
			});
		}

		<b>public static int</b> <a id="155e97d2127c5fa0" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Hex2Dec</a>(<b>string</b> <span id="r7 rd" class="r7 r">hex</span>)
		{
			<b>return</b> <a href="@0@mscorlib/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@0@mscorlib/A.html#a43f243d86ce6152" class="i method">ToInt32</a>(<span class="r7 r">hex</span>, 16);
		}

		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Convert a string to a XWT color</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">ColorName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The color name or the color hexadecimal RGB</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Xwt.Drawing.Color that corresponds the requested colour</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
		<b>public static</b> <a href="/Xwt3/A.html#773e78572598ea91" class="t t">Color</a> <a id="9a91ecb07286f089" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetXwtColor</a>(<b>string</b> <span id="r8 rd" class="r8 r">ColorName</span>)
		{
			<b>if</b> (<span class="r8 r">ColorName</span>.<a href="@0@mscorlib/A.html#2d51c212cb09178e" class="i method">ToLowerInvariant</a>() == <span class="s">&quot;transparent&quot;</span>)
			{
				<b>return</b> <a href="/Xwt3/A.html#d59be10d673b4d2a" class="t t">Colors</a>.<a href="/Xwt3/A.html#9877b0236462cda5" class="i field">Transparent</a>;
			}

			<span class="c">/*string rgbhex;
			if (ColorName.StartsWith(&quot;#&quot;))
				rgbhex = ColorName.Substring(1);
			else
				rgbhex = ColorName;
			if (rgbhex.Length != 6) return Xwt.Drawing.Color.FromName(ColorName);
			//todo: add support of rgba, hsl

			string[] colors16 = new string[3];
			colors16[0] = rgbhex.Substring(0, 1) + rgbhex.Substring(1, 1);
			colors16[1] = rgbhex.Substring(2, 1) + rgbhex.Substring(3, 1);
			colors16[2] = rgbhex.Substring(4, 1) + rgbhex.Substring(5, 1);
			int[] colors10 = new int[3];
			for (int i = 0; i &lt; 3; i++)
			{
				colors10[i] = Hex2Dec(colors16[i]);
			}
			return new Xwt.Drawing.Color(colors10[0], colors10[1], colors10[2]);*/</span>
			<b>return</b> <a href="/Xwt3/A.html#773e78572598ea91" class="t t">Color</a>.<a href="/Xwt3/A.html#07ded38529dbcd27" class="i method">FromName</a>(<span class="r8 r">ColorName</span>);
		}

		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Loads embedded resource</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">resourceName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the resource</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">assembly</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The assembly, which contains the resource</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<b>public static string</b> <a id="81320772256a6158" href="../R/81320772256a6158.html" target="n" data-glyph="72,1" class="i method">GetEmbeddedResource</a>(<b>string</b> <span id="r9 rd" class="r9 r">resourceName</span>, <a href="@0@mscorlib/A.html#73b5be5e9c2474b2" class="t t">Assembly</a> <span id="r10 rd" class="r10 r">assembly</span>)
		{
			<span class="r9 r">resourceName</span> = <a href="#12c9a107c03f14a1" class="i method">FormatResourceName</a>(<span class="r10 r">assembly</span>, <span class="r9 r">resourceName</span>);
			<b>using</b> (<a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r11 rd" class="r11 r">resourceStream</span> = <span class="r10 r">assembly</span>.<a href="@0@mscorlib/A.html#9c90fad516060e0d" class="i method">GetManifestResourceStream</a>(<span class="r9 r">resourceName</span>))
			{
				<b>if</b> (<span class="r11 r">resourceStream</span> == <b>null</b>)
					<b>return null</b>;

				<b>using</b> (<a href="@0@mscorlib/A.html#b5fe1efcec14de32" class="t t">StreamReader</a> <span id="r12 rd" class="r12 r">reader</span> = <b>new</b> <a href="@0@mscorlib/A.html#72447927169f6b77" class="t constructor">StreamReader</a>(<span class="r11 r">resourceStream</span>))
				{
					<b>return</b> <span class="r12 r">reader</span>.<a href="@0@mscorlib/A.html#dc5c2420e739a03e" class="i method">ReadToEnd</a>();
				}
			}
		}

		<b>private static string</b> <a id="12c9a107c03f14a1" href="../R/12c9a107c03f14a1.html" target="n" data-glyph="76,1" class="i method">FormatResourceName</a>(<a href="@0@mscorlib/A.html#73b5be5e9c2474b2" class="t t">Assembly</a> <span id="r13 rd" class="r13 r">assembly</span>, <b>string</b> <span id="r14 rd" class="r14 r">resourceName</span>)
		{
			<b>return</b> <span class="r13 r">assembly</span>.<a href="@0@mscorlib/A.html#1fd23b897ffa9a75" class="i method">GetName</a>().<a href="@0@mscorlib/A.html#917bceeed23fe2ae" class="i property">Name</a> + <span class="s">&quot;.&quot;</span> + <span class="r14 r">resourceName</span>.<a href="@0@mscorlib/A.html#69fc1d0aa6df8a90" class="i method">Replace</a>(<span class="s">&quot; &quot;</span>, <span class="s">&quot;_&quot;</span>)
															   .<a href="@0@mscorlib/A.html#69fc1d0aa6df8a90" class="i method">Replace</a>(<span class="s">&quot;\\&quot;</span>, <span class="s">&quot;.&quot;</span>)
															   .<a href="@0@mscorlib/A.html#69fc1d0aa6df8a90" class="i method">Replace</a>(<span class="s">&quot;/&quot;</span>, <span class="s">&quot;.&quot;</span>);
		}

		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Loads embedded resource from current program</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">resourceName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the resource</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<b>public static string</b> <a id="ec3167c4e5ad00d7" href="../R/ec3167c4e5ad00d7.html" target="n" data-glyph="72,1" class="i method">GetEmbeddedResource</a>(<b>string</b> <span id="r15 rd" class="r15 r">resourceName</span>)
		{
			<b>return</b> <a href="#81320772256a6158" class="i method">GetEmbeddedResource</a>(<span class="r15 r">resourceName</span>, <a href="@0@mscorlib/A.html#73b5be5e9c2474b2" class="t t">Assembly</a>.<a href="@0@mscorlib/A.html#bd671af9926207e9" class="i method">GetExecutingAssembly</a>());
		}

		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Returns current XWT backend name (WPF, Gtk, Mon(o.Mac), Coc(oa) etc)</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">WPF if WPF, Gtk if GTK, Mon if MonoMac, Coc if Cocoa</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
		<b>public static string</b> <a id="270554b63a903af1" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetXwtBackendName</a>()
		{
			<b>return</b> <span class="i n">Xwt</span>.<a href="/Xwt3/A.html#b9022100aba37d61" class="t t">Toolkit</a>.<a href="/Xwt3/A.html#0a642b3cabd70407" class="i property">CurrentEngine</a>.<a href="/Xwt3/A.html#0a3c3df0331a3e45" class="i method">GetSafeBackend</a> (<b>new</b> <a href="/Xwt3/A.html#172e94430813a75f" class="t constructor">Window</a>()).<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>().<a href="@0@mscorlib/A.html#8124961f027d9ac9" class="i method">Substring</a>(4,3);
		}

		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Search for icon of the selected MIME type</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">MIME</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The MIME type (i.e. application/msword)</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
		<b>public static</b> <a href="/Xwt3/A.html#0e6b2faf07047267" class="t t">Image</a> <a id="6fe334e58dce3aac" href="../R/6fe334e58dce3aac.html" target="n" data-glyph="72,1" class="i method">GetIconForMIME</a>(<b>string</b> <span id="r16 rd" class="r16 r">MIME</span>)
		{
            <b>try</b>
            {
                <b>if</b> (<span class="r16 r">MIME</span> == <span class="s">&quot;x-fcmd/directory&quot;</span>)
                    <b>return</b> <a href="#09296b17d80c5c15" class="i method">GetLocalIcon</a>(<span class="s">&quot;pluginner.Resources.x-fcmd-directory.png&quot;</span>);
 
                <b>if</b> (<span class="r16 r">MIME</span> == <span class="s">&quot;x-fcmd/up&quot;</span>)
                    <b>return</b> <a href="#09296b17d80c5c15" class="i method">GetLocalIcon</a>(<span class="s">&quot;pluginner.Resources.x-fcmd-up.png&quot;</span>);
 
                <b>if</b> (<a href="#15f42c561fe03508" class="i method">CheckForIcon</a>(<span class="r16 r">MIME</span>.<a href="@0@mscorlib/A.html#69fc1d0aa6df8a90" class="i method">Replace</a>(<span class="s">&quot;/&quot;</span>, <span class="s">&quot;-&quot;</span>)))
                {
                    <b>return</b> <a href="#a09500368acd5fd3" class="i method">GetIconFromCache</a>(<span class="r16 r">MIME</span>.<a href="@0@mscorlib/A.html#69fc1d0aa6df8a90" class="i method">Replace</a>(<span class="s">&quot;/&quot;</span>, <span class="s">&quot;-&quot;</span>));
                }
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a>)
            {
                <b>return null</b>;
            }

			<span class="c">//подбор иконки по миме типу</span>

			<b>if</b> (<a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#67900ccbbcff63a2" class="i property">OSVersion</a>.<a href="@0@mscorlib/A.html#f23195260b6f56fc" class="i property">Platform</a> == <a href="@0@mscorlib/A.html#065a6a7be5e74336" class="t t">PlatformID</a>.<a href="@0@mscorlib/A.html#953dcb25cf190546" class="i field">Win32NT</a>){
				<span class="c">//On win32, to get the icon, it is need to go through the ass and exit from the nose</span>
				<span class="c">//if you are unhappy, possibly you will exit through genitalia or ear</span>

				<span class="c">/* Предисловие.
				 * На платформе Windows поиск иконки для файлов по MIME-типу без обращения к WinAPI - весёлая история.
				 * Мазохизм на примере application/msword (Word for Windows 97-2003):
				 * \\\Registry\HKEY_CLASSES_ROOT\MIME\Database\Content Type\application/msword\Extension
				 * \\\Registry\HKEY_CLASSES_ROOT\.doc\(Default)
				 * \\\Registry\HKEY_CLASSES_ROOT\Word.Document.8\DefaultIcon\(Default)
				 * Извлечь ресурс №1 из C:\\Windows\\Installer\\{90110419-6000-11D3-8CFE-0150048383C9}\\wordicon.exe
				 * Сконвертировать ICO в рисунок 16x16 px подходящего формата.
				 * 
				 * Недостаток данного метода в том, что не все расширения в Windows связаны с MIME-типом. Яркий
				 * пример - файлы Visual Studio/VC#/VB.NET. Их можно представить в виде zz-application/zz-winassoc-xxx,
				 * где ххх - расширение. Поэтому, используется второй метод определения иконки.
				 */</span>

				<span class="c">//Том 1. Определение по расширению.</span>
				<b>if</b> (<span class="r16 r">MIME</span>.<a href="@0@mscorlib/A.html#23804789ea4c9c0e" class="i method">StartsWith</a>(<span class="s">&quot;zz-application/zz-winassoc&quot;</span>))
				{
					<b>string</b> <span id="r17 rd" class="r17 r">w32type</span> = <b>null</b>, <span id="r18 rd" class="r18 r">w32icon</span> = <b>null</b>;
					<b>try</b>
					{
						<span class="c">//определение типа Win32 (Word.Document.8)</span>
						<span class="r17 r">w32type</span> =
							<a href="@0@mscorlib/A.html#1b1d922117815d60" class="t t">Registry</a>.<a href="@0@mscorlib/A.html#4bc76cc95cc421d4" class="i field">ClassesRoot</a>
							.<a href="@0@mscorlib/A.html#537f1afcd9c6e89d" class="i method">OpenSubKey</a>(<span class="s">&quot;.&quot;</span>+<span class="r16 r">MIME</span>.<a href="@0@mscorlib/A.html#882fa7998d6ca35a" class="i method">Substring</a>(27))
							.<a href="@0@mscorlib/A.html#29b18a8139ca3964" class="i method">GetValue</a>(<span class="s">&quot;&quot;</span>)
							.<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>();

						<span class="c">//определение пути к иконке</span>
						<span class="r18 r">w32icon</span> =
							<a href="@0@mscorlib/A.html#1b1d922117815d60" class="t t">Registry</a>.<a href="@0@mscorlib/A.html#4bc76cc95cc421d4" class="i field">ClassesRoot</a>
							.<a href="@0@mscorlib/A.html#537f1afcd9c6e89d" class="i method">OpenSubKey</a>(<span class="r17 r">w32type</span>)
							.<a href="@0@mscorlib/A.html#537f1afcd9c6e89d" class="i method">OpenSubKey</a>(<span class="s">&quot;DefaultIcon&quot;</span>)
							.<a href="@0@mscorlib/A.html#29b18a8139ca3964" class="i method">GetValue</a>(<span class="s">&quot;&quot;</span>)
							.<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>();

						<span class="c">//извлечение иконки, сохренение в кэш и загрузка в виде XWT Image</span>
<span class="c">// ReSharper disable once ConditionIsAlwaysTrueOrFalse</span>
						<b>if</b> (<span class="r18 r">w32icon</span> == <b>null</b>) <b>goto</b> <span class="i">mime_icon_fallback</span>;
						<a href="@0@System.Drawing/A.html#81a28d20524554ae" class="t t">Icon</a> <span id="r19 rd" class="r19 r">i</span> =
						<a href="#9e2a0f826e46ad93" class="i method">ExtractIconFromFile</a>(<span class="r18 r">w32icon</span>, <b>false</b>);

						<b>if</b> (<span class="r19 r">i</span> == <b>null</b>) { <a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#406b854997305c45" class="i method">WriteLine</a>(<span class="s">&quot;Extracted icon wasn&#39;t received for {0}; posssibly broken EXE/DLL or a 32/64-bit mistake&quot;</span>, <span class="r18 r">w32icon</span>); <b>goto</b> <span class="i">mime_icon_fallback</span>; }
						<a href="#33a075cec31d1ba8" class="i method">SaveIconToCache</a>(<span class="r19 r">i</span>,<span class="r16 r">MIME</span>.<a href="@0@mscorlib/A.html#69fc1d0aa6df8a90" class="i method">Replace</a>(<span class="s">&quot;/&quot;</span>, <span class="s">&quot;-&quot;</span>));
						<b>return</b> <a href="#a09500368acd5fd3" class="i method">GetIconFromCache</a>(<span class="r16 r">MIME</span>.<a href="@0@mscorlib/A.html#69fc1d0aa6df8a90" class="i method">Replace</a>(<span class="s">&quot;/&quot;</span>, <span class="s">&quot;-&quot;</span>));
					}
					<b>catch</b>
					{ <a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#406b854997305c45" class="i method">WriteLine</a>(<span class="s">&quot;Warning: FC is unable to get icon for .{0}&quot;</span>, <span class="r17 r">w32type</span>); }

					<b>if</b> (<span class="r17 r">w32type</span> == <b>null</b>) <b>goto</b> <span class="i">mime_icon_fallback</span>;
					<b>if</b> (<span class="r18 r">w32icon</span> == <b>null</b>) <b>goto</b> <span class="i">mime_icon_fallback</span>;
				}

				<span class="c">//Том 2. Опеределение по MIME-типу.</span>
				<span class="c">//Глава 1. Определение расширения.</span>
				<b>string</b> <span id="r20 rd" class="r20 r">Win32extension</span> = <b>null</b>;
				<b>try</b>
				{
					<span class="r20 r">Win32extension</span> =
						<a href="@0@mscorlib/A.html#1b1d922117815d60" class="t t">Registry</a>.<a href="@0@mscorlib/A.html#4bc76cc95cc421d4" class="i field">ClassesRoot</a>
						.<a href="@0@mscorlib/A.html#537f1afcd9c6e89d" class="i method">OpenSubKey</a>(<span class="s">@&quot;MIME\Database\Content Type\&quot;</span> + <span class="r16 r">MIME</span>)
						.<a href="@0@mscorlib/A.html#29b18a8139ca3964" class="i method">GetValue</a>(<span class="s">&quot;Extension&quot;</span>)
						.<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>();
				}
				<b>catch</b>
				{ <a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#5ac7c4fda643413b" class="i method">WriteLine</a>(<span class="s">&quot;Warning: No extension associated for &quot;</span> + <span class="r16 r">MIME</span> + <span class="s">&quot; in the Windows registry&quot;</span>); }

				<b>if</b> (<span class="r20 r">Win32extension</span> == <b>null</b>) <b>goto</b> <span class="i">mime_icon_fallback</span>;

				<span class="c">//Глава 2. Определение Windows&#39;овского названия типа.</span>
				<b>string</b> <span id="r21 rd" class="r21 r">Win32name</span> = <b>null</b>;
				<b>try</b>
				{
					<span class="r21 r">Win32name</span> =
						<a href="@0@mscorlib/A.html#1b1d922117815d60" class="t t">Registry</a>.<a href="@0@mscorlib/A.html#4bc76cc95cc421d4" class="i field">ClassesRoot</a>
						.<a href="@0@mscorlib/A.html#537f1afcd9c6e89d" class="i method">OpenSubKey</a>(<span class="r20 r">Win32extension</span>)
						.<a href="@0@mscorlib/A.html#29b18a8139ca3964" class="i method">GetValue</a>(<span class="s">&quot;&quot;</span>)
						.<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>();
				}
				<b>catch</b>
				{ <a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#45cf4dc5a446377f" class="i method">WriteLine</a>(<span class="s">&quot;Warning: No filetype associated at HKEY_CLASSES_ROOT\\{0} ({1}) in the Windows registry&quot;</span>, <span class="r20 r">Win32extension</span>, <span class="r16 r">MIME</span>); }

				<b>if</b> (<span class="r21 r">Win32name</span> == <b>null</b>) <b>goto</b> <span class="i">mime_icon_fallback</span>;

				<span class="c">//Глава 3. Определение ассоциированного файла-хранителя иконки.</span>
				<b>string</b> <span id="r22 rd" class="r22 r">PathToIcon</span> = <b>null</b>;
				<b>try</b>
				{
					<span class="r22 r">PathToIcon</span> =
						<a href="@0@mscorlib/A.html#1b1d922117815d60" class="t t">Registry</a>.<a href="@0@mscorlib/A.html#4bc76cc95cc421d4" class="i field">ClassesRoot</a>
						.<a href="@0@mscorlib/A.html#537f1afcd9c6e89d" class="i method">OpenSubKey</a>(<span class="r21 r">Win32name</span>)
						.<a href="@0@mscorlib/A.html#537f1afcd9c6e89d" class="i method">OpenSubKey</a>(<span class="s">&quot;DefaultIcon&quot;</span>)
						.<a href="@0@mscorlib/A.html#29b18a8139ca3964" class="i method">GetValue</a>(<span class="s">&quot;&quot;</span>)
						.<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>();
				}
				<b>catch</b>
				{ <a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#45cf4dc5a446377f" class="i method">WriteLine</a>(<span class="s">&quot;Warning: No default icon is stored at HKEY_CLASSES_ROOT\\{0}\\DefaultIcon (for {1}) in the Windows registry&quot;</span>, <span class="r21 r">Win32name</span>, <span class="r16 r">MIME</span>); }

				<b>if</b> (<span class="r22 r">PathToIcon</span> == <b>null</b>) <b>goto</b> <span class="i">mime_icon_fallback</span>;

				<span class="c">//Глава 4. Извлечение иконки 16х16.</span>
				<a href="@0@System.Drawing/A.html#81a28d20524554ae" class="t t">Icon</a> <span id="r23 rd" class="r23 r">ic</span> =
				<a href="#9e2a0f826e46ad93" class="i method">ExtractIconFromFile</a>(<span class="r22 r">PathToIcon</span>, <b>false</b>); <span class="c">//SEE BUG #7</span>

				<span class="c">//Глава 5. Сохранение иконки в кэш и выдача готовой.</span>
				<b>if</b> (<span class="r23 r">ic</span> == <b>null</b>) { <a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#406b854997305c45" class="i method">WriteLine</a>(<span class="s">&quot;Extracted icon wasn&#39;t received for {0}; posssibly broken EXE/DLL or a 32/64-bit mistake&quot;</span>, <span class="r22 r">PathToIcon</span>); <b>goto</b> <span class="i">mime_icon_fallback</span>; }
				<a href="#33a075cec31d1ba8" class="i method">SaveIconToCache</a>(<span class="r23 r">ic</span>, <span class="r16 r">MIME</span>.<a href="@0@mscorlib/A.html#69fc1d0aa6df8a90" class="i method">Replace</a>(<span class="s">&quot;/&quot;</span>, <span class="s">&quot;-&quot;</span>));
				<b>return</b> <a href="#a09500368acd5fd3" class="i method">GetIconFromCache</a>(<span class="r16 r">MIME</span>.<a href="@0@mscorlib/A.html#69fc1d0aa6df8a90" class="i method">Replace</a>(<span class="s">&quot;/&quot;</span>, <span class="s">&quot;-&quot;</span>));
			}

			<span class="c">//UNDONE: забубенить выдирание иконок из катАлагав /etc/mime; ~/.mime</span>
			<span class="c">//TODO: сделать поддержку MacOS X.</span>
			
			<span class="i">mime_icon_fallback</span>:
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">DEBUG</span>
			<b>if</b>(<span class="r16 r">MIME</span> != <span class="s">&quot;application/octet-stream&quot;</span>)
			<a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#5ac7c4fda643413b" class="i method">WriteLine</a>(<span class="s">&quot;utilities: Can&#39;t find an icon for &quot;</span> + <span class="r16 r">MIME</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
			<b>return</b> <a href="#09296b17d80c5c15" class="i method">GetLocalIcon</a>(<span class="s">&quot;pluginner.Resources.application-octet-stream.png&quot;</span>);
		}

		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Finds a MIME content-type of a file</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r24 r">Extension</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The file&#39;s extension</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The content type</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
		<b>public static string</b> <a id="25ec5cf1758f9e58" href="../R/25ec5cf1758f9e58.html" target="n" data-glyph="72,1" class="i method">GetContentType</a>(<b>string</b> <span id="r24 rd" class="r24 r">Extension</span>)
		{
			<b>if</b> (<span class="r24 r">Extension</span>.<a href="@0@mscorlib/A.html#e13f5829ef28aa07" class="i property">Length</a> == 0)
			{
				<b>return</b> <span class="s">&quot;application/octet-stream&quot;</span>;
			}

			<b>if</b> (<a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#67900ccbbcff63a2" class="i property">OSVersion</a>.<a href="@0@mscorlib/A.html#f23195260b6f56fc" class="i property">Platform</a> == <a href="@0@mscorlib/A.html#065a6a7be5e74336" class="t t">PlatformID</a>.<a href="@0@mscorlib/A.html#953dcb25cf190546" class="i field">Win32NT</a>)
			{
				<span class="c">//win32 way</span>
				<b>string</b> <span id="r25 rd" class="r25 r">CT</span> = <span class="s">&quot;application/octet-stream&quot;</span>;

				<a href="@0@mscorlib/A.html#8816e0f3c40b0213" class="t t">RegistryKey</a> <span id="r26 rd" class="r26 r">regKey</span> = <a href="@0@mscorlib/A.html#1b1d922117815d60" class="t t">Registry</a>.<a href="@0@mscorlib/A.html#4bc76cc95cc421d4" class="i field">ClassesRoot</a>.<a href="@0@mscorlib/A.html#537f1afcd9c6e89d" class="i method">OpenSubKey</a>(
					<span class="r24 r">Extension</span>.<a href="@0@mscorlib/A.html#0b5a1ee33618e0b3" class="i method">ToLower</a>()
					);

				<b>if</b> (<span class="r26 r">regKey</span> != <b>null</b>){
					<b>object</b> <span id="r27 rd" class="r27 r">contentType</span> = <span class="r26 r">regKey</span>.<a href="@0@mscorlib/A.html#29b18a8139ca3964" class="i method">GetValue</a>(<span class="s">&quot;Content Type&quot;</span>);

					<b>if</b> (<span class="r27 r">contentType</span> != <b>null</b>)
						<span class="r25 r">CT</span> = <span class="r27 r">contentType</span>.<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>();
						<b>return</b> <span class="r25 r">CT</span>;
				}
			}
			<span class="c">//todo: Linux/BSD (shared-mime-info) way and an macosx way</span>

			<b>return</b> <span class="s">&quot;zz-application/zz-winassoc-&quot;</span> + <span class="r24 r">Extension</span>;
		}

		<span class="k preprocess">#</span><span class="k preprocess">region</span> Icon Cache utilities
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Save a Windows icon to cache</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r28 r">sdi</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The System.Drawing.Icon, which needs to be saved</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The icon name</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">size</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The icon size</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<b>public static void</b> <a id="33a075cec31d1ba8" href="../R/33a075cec31d1ba8.html" target="n" data-glyph="72,1" class="i method">SaveIconToCache</a>(<a href="@0@System.Drawing/A.html#81a28d20524554ae" class="t t">Icon</a> <span id="r28 rd" class="r28 r">sdi</span>, <b>string</b> <span id="r29 rd" class="r29 r">name</span>, <b>int</b> <span id="r30 rd" class="r30 r">size</span> = 16)
		{
			<b>if</b> (!<a href="@0@mscorlib/A.html#b3ad5f0ba800bb28" class="t t">Directory</a>.<a href="@0@mscorlib/A.html#6a2a3bee6b62826f" class="i method">Exists</a>(<a href="#7f93071e86196721" class="i field">PathToIcons</a> + <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#d1bb57592858d485" class="i field">DirectorySeparatorChar</a> + <span class="r30 r">size</span>))
			{
				<a href="@0@mscorlib/A.html#b3ad5f0ba800bb28" class="t t">Directory</a>.<a href="@0@mscorlib/A.html#5c99436f88797b6a" class="i method">CreateDirectory</a>(<a href="#7f93071e86196721" class="i field">PathToIcons</a> + <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#d1bb57592858d485" class="i field">DirectorySeparatorChar</a> + <span class="r30 r">size</span>);
			}

			<b>string</b> <span id="r31 rd" class="r31 r">IconPath</span> = <a href="#7f93071e86196721" class="i field">PathToIcons</a> + <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#d1bb57592858d485" class="i field">DirectorySeparatorChar</a> + <span class="r30 r">size</span> + <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#d1bb57592858d485" class="i field">DirectorySeparatorChar</a> + <span class="r29 r">name</span> + <span class="s">&quot;.png&quot;</span>;
			<span class="r28 r">sdi</span>.<a href="@0@System.Drawing/A.html#3b0845f329112dce" class="i method">ToBitmap</a>().<a href="@0@System.Drawing/A.html#42559a71d4a2b11c" class="i method">Save</a>(<span class="r31 r">IconPath</span>);
		}

		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Reads an icon from icon cache</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r32 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The icon name</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r33 r">size</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The icon size</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The icon as an XWT Image.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
		<b>public static</b> <a href="/Xwt3/A.html#0e6b2faf07047267" class="t t">Image</a> <a id="a09500368acd5fd3" href="../R/a09500368acd5fd3.html" target="n" data-glyph="72,1" class="i method">GetIconFromCache</a>(<b>string</b> <span id="r32 rd" class="r32 r">name</span>, <b>int</b> <span id="r33 rd" class="r33 r">size</span> = 16)
		{
			<b>string</b> <span id="r34 rd" class="r34 r">IconPath</span> = <a href="#7f93071e86196721" class="i field">PathToIcons</a> + <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#d1bb57592858d485" class="i field">DirectorySeparatorChar</a> + <span class="r33 r">size</span> + <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#d1bb57592858d485" class="i field">DirectorySeparatorChar</a> + <span class="r32 r">name</span> + <span class="s">&quot;.png&quot;</span>;

			<b>if</b>(!<span class="i n">System</span>.<span class="i n">IO</span>.<a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#3360368484a9f131" class="i method">Exists</a>(<span class="r34 r">IconPath</span>))
				<b>return</b> <a href="/Xwt3/A.html#0e6b2faf07047267" class="t t">Image</a>.<a href="/Xwt3/A.html#c120d96e5b046a5f" class="i method">FromResource</a>(<span class="s">&quot;pluginner.Resources.application-octet-stream.png&quot;</span>);
			<b>else
				return</b> <a href="/Xwt3/A.html#0e6b2faf07047267" class="t t">Image</a>.<a href="/Xwt3/A.html#bd2212312cca9ff8" class="i method">FromStream</a>(<span class="i n">System</span>.<span class="i n">IO</span>.<a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#7a7d1c864bec521e" class="i method">OpenRead</a>(<span class="r34 r">IconPath</span>));
				<span class="c">//this way is better than Xwt.Drawing.Image.FromFile because of some GTK# issues</span>
		}

		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Check for existing of an icon</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The icon name</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">size</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The icon preferred size</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True or false, or there is other boolean values???</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
		<b>public static bool</b> <a id="15f42c561fe03508" href="../R/15f42c561fe03508.html" target="n" data-glyph="72,1" class="i method">CheckForIcon</a>(<b>string</b> <span id="r35 rd" class="r35 r">name</span>, <b>int</b> <span id="r36 rd" class="r36 r">size</span> = 16){
			<b>string</b> <span id="r37 rd" class="r37 r">IconPath</span> = <a href="#7f93071e86196721" class="i field">PathToIcons</a> + <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#d1bb57592858d485" class="i field">DirectorySeparatorChar</a> + <span class="r36 r">size</span> + <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#d1bb57592858d485" class="i field">DirectorySeparatorChar</a> + <span class="r35 r">name</span> + <span class="s">&quot;.png&quot;</span>;
			<b>return</b> <span class="i n">System</span>.<span class="i n">IO</span>.<a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#3360368484a9f131" class="i method">Exists</a>(<span class="r37 r">IconPath</span>);<span class="c">//todo: replace with better detection code, with support for low-res icon finding</span>
		}
		<span class="k preprocess">#</span><span class="k preprocess">endregion</span>

		<span class="k preprocess">#</span><span class="k preprocess">region</span> Extractor for icons inside Win32 PE files (EXE, DLL)
		<span class="c">//the following code based on code from http://www.codeproject.com/Articles/29137/Get-Registered-File-Types-and-Their-Associated-Ico</span>

		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> Structure that encapsulates basic information of icon embedded in a file.</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<b>public struct</b> <a id="0d941cd969d060bf" href="../R/0d941cd969d060bf.html" target="n" data-glyph="108,1" class="t t"><span id="f245a70718bfab3a">EmbeddedIconInfo</span></a>
		{
			<b>public string</b> <a id="057a9a095a3cac64" href="../R/057a9a095a3cac64.html" target="n" data-glyph="42,2" class="i field">FileName</a>;
			<b>public int</b> <a id="0170f478f5d6627e" href="../R/0170f478f5d6627e.html" target="n" data-glyph="42,2" class="i field">IconIndex</a>;
		}

		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> Parses the parameters string to the structure of EmbeddedIconInfo.</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r38 r">fileAndParam</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The params string, such as ex: </span>
		<span class="c">///</span><span class="c">    &quot;C:\\Program Files\\NetMeeting\\conf.exe,1&quot;.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<b>public static</b> <a href="#0d941cd969d060bf" class="t t">EmbeddedIconInfo</a> <a id="441ee3e92bfacbbc" href="../R/441ee3e92bfacbbc.html" target="n" data-glyph="72,1" class="i method">getEmbeddedIconInfo</a>(<b>string</b> <span id="r38 rd" class="r38 r">fileAndParam</span>)
		{
			<a href="#0d941cd969d060bf" class="t t">EmbeddedIconInfo</a> <span id="r39 rd" class="r39 r">embeddedIcon</span> = <b>new</b> <a href="#0d941cd969d060bf" class="t constructor">EmbeddedIconInfo</a>();

			<b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r38 r">fileAndParam</span>))
				<b>return</b> <span class="r39 r">embeddedIcon</span>;

			<span class="c">//Use to store the file contains icon.</span>
			<b>string</b> <span id="r40 rd" class="r40 r">fileName</span> = <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@0@mscorlib/A.html#c9f70a27facb27cf" class="i field">Empty</a>;

			<span class="c">//The index of the icon in the file.</span>
			<b>int</b> <span id="r41 rd" class="r41 r">iconIndex</span> = 0;
			<b>string</b> <span id="r42 rd" class="r42 r">iconIndexString</span> = <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@0@mscorlib/A.html#c9f70a27facb27cf" class="i field">Empty</a>;

			<b>int</b> <span id="r43 rd" class="r43 r">commaIndex</span> = <span class="r38 r">fileAndParam</span>.<a href="@0@mscorlib/A.html#7d6aed52d875ec59" class="i method">IndexOf</a>(<span class="s">&quot;,&quot;</span>, <a href="@0@mscorlib/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@0@mscorlib/A.html#87891a6d28c64c9b" class="i field">Ordinal</a>);
			<span class="c">//if fileAndParam is some thing likes this: </span>
				 <span class="c">//&quot;C:\\Program Files\\NetMeeting\\conf.exe,1&quot;.</span>
			<b>if</b> (<span class="r43 r">commaIndex</span> &gt; 0)
			{
				<span class="r40 r">fileName</span> = <span class="r38 r">fileAndParam</span>.<a href="@0@mscorlib/A.html#8124961f027d9ac9" class="i method">Substring</a>(0, <span class="r43 r">commaIndex</span>);
				<span class="r42 r">iconIndexString</span> = <span class="r38 r">fileAndParam</span>.<a href="@0@mscorlib/A.html#882fa7998d6ca35a" class="i method">Substring</a>(<span class="r43 r">commaIndex</span> + 1);
			}
			<b>else</b>
				<span class="r40 r">fileName</span> = <span class="r38 r">fileAndParam</span>;
    
			<b>if</b> (!<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r42 r">iconIndexString</span>))
			{
				<span class="c">//Get the index of icon.</span>
				<span class="r41 r">iconIndex</span> = <b>int</b>.<a href="@0@mscorlib/A.html#a438016f815a35c3" class="i method">Parse</a>(<span class="r42 r">iconIndexString</span>);
				<span class="c">/*if (iconIndex &lt; 0)
					iconIndex = 0;  //To avoid the invalid index.
				 * may cause unexpeced benaviour
				 */</span>
			}
    
			<span class="r39 r">embeddedIcon</span>.<a href="#057a9a095a3cac64" class="i field">FileName</a> = <span class="r40 r">fileName</span>;
			<span class="r39 r">embeddedIcon</span>.<a href="#0170f478f5d6627e" class="i field">IconIndex</a> = <span class="r41 r">iconIndex</span>;

			<b>return</b> <span class="r39 r">embeddedIcon</span>;
		}

		[<a href="@0@mscorlib/A.html#19ddb78edbb90890" class="t constructor">DllImport</a>(<span class="s">&quot;shell32.dll&quot;</span>, <a href="@0@mscorlib/A.html#6ef7f9c5dd563f57" class="i field">CharSet</a> = <a href="@0@mscorlib/A.html#6709eaeb0ea384cc" class="t t">CharSet</a>.<a href="@0@mscorlib/A.html#f9a518f8d0d9ba35" class="i field">Auto</a>)]
		<b>private static extern uint</b> <a id="6d3022961a465d3e" href="../R/6d3022961a465d3e.html" target="n" data-glyph="76,1" class="i method">ExtractIconEx</a> 
			(<b>string</b> <span id="r44 rd" class="r44 r">szFileName</span>, <b>int</b> <span id="r45 rd" class="r45 r">nIconIndex</span>, 
			<a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>[] <span id="r46 rd" class="r46 r">phiconLarge</span>, <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>[] <span id="r47 rd" class="r47 r">phiconSmall</span>, <b>uint</b> <span id="r48 rd" class="r48 r">nIcons</span>);

		[<a href="@0@mscorlib/A.html#19ddb78edbb90890" class="t constructor">DllImport</a>(<span class="s">&quot;user32.dll&quot;</span>, <a href="@0@mscorlib/A.html#1c9515df8d34df81" class="i field">EntryPoint</a> = <span class="s">&quot;DestroyIcon&quot;</span>, <a href="@0@mscorlib/A.html#e0fee96b37c60a97" class="i field">SetLastError</a> = <b>true</b>)]
		<b>private static extern int</b> <a id="95644f64d622943c" href="../R/95644f64d622943c.html" target="n" data-glyph="76,1" class="i method">DestroyIcon</a> (<a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a> <span id="r49 rd" class="r49 r">hIcon</span>);
		
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> Extract the icon from file.</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r50 r">fileAndParam</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The params string, such as ex: </span>
		<span class="c">///</span><span class="c">    &quot;C:\\Program Files\\NetMeeting\\conf.exe,1&quot;.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span><span class="c"> </span><span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r51 r">isLarge</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Determines the returned icon is a large </span>
		<span class="c">///</span><span class="c">    (may be 32x32 px) or small icon (16x16 px).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
		<b>public static</b> <a href="@0@System.Drawing/A.html#81a28d20524554ae" class="t t">Icon</a> <a id="9e2a0f826e46ad93" href="../R/9e2a0f826e46ad93.html" target="n" data-glyph="72,1" class="i method">ExtractIconFromFile</a>(<b>string</b> <span id="r50 rd" class="r50 r">fileAndParam</span>, <b>bool</b> <span id="r51 rd" class="r51 r">isLarge</span>)
		{
			<b>uint</b> <span id="r52 rd" class="r52 r">readIconCount</span> = 0;
			<a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>[] <span id="r53 rd" class="r53 r">hDummy</span> = <b>new</b> <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>[1] { <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>.<a href="@0@mscorlib/A.html#d46202ed9b6005b2" class="i field">Zero</a> };
			<a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>[] <span id="r54 rd" class="r54 r">hIconEx</span> = <b>new</b> <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>[1] { <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>.<a href="@0@mscorlib/A.html#d46202ed9b6005b2" class="i field">Zero</a> };

			<b>try</b>
			{
				<a href="#0d941cd969d060bf" class="t t">EmbeddedIconInfo</a> <span id="r55 rd" class="r55 r">embeddedIcon</span> =
					<a href="#441ee3e92bfacbbc" class="i method">getEmbeddedIconInfo</a>(<span class="r50 r">fileAndParam</span>);

				<b>if</b> (<span class="r51 r">isLarge</span>)
					<span class="r52 r">readIconCount</span> = <a href="#6d3022961a465d3e" class="i method">ExtractIconEx</a>
						(<span class="r55 r">embeddedIcon</span>.<a href="#057a9a095a3cac64" class="i field">FileName</a>, <span class="r55 r">embeddedIcon</span>.<a href="#0170f478f5d6627e" class="i field">IconIndex</a>, <span class="r54 r">hIconEx</span>, <span class="r53 r">hDummy</span>, 1);
				<b>else</b>
					<span class="r52 r">readIconCount</span> = <a href="#6d3022961a465d3e" class="i method">ExtractIconEx</a>
						(<span class="r55 r">embeddedIcon</span>.<a href="#057a9a095a3cac64" class="i field">FileName</a>, <span class="r55 r">embeddedIcon</span>.<a href="#0170f478f5d6627e" class="i field">IconIndex</a>, <span class="r53 r">hDummy</span>, <span class="r54 r">hIconEx</span>, 1);

				<b>if</b> (<span class="r52 r">readIconCount</span> &gt; 0 &amp;&amp; <span class="r54 r">hIconEx</span>[0] != <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>.<a href="@0@mscorlib/A.html#d46202ed9b6005b2" class="i field">Zero</a>)
				{
					<span class="c">//Get first icon.</span>
					<a href="@0@System.Drawing/A.html#81a28d20524554ae" class="t t">Icon</a> <span id="r56 rd" class="r56 r">extractedIcon</span> =
						(<a href="@0@System.Drawing/A.html#81a28d20524554ae" class="t t">Icon</a>)<a href="@0@System.Drawing/A.html#81a28d20524554ae" class="t t">Icon</a>.<a href="@0@System.Drawing/A.html#3a4e2c70109d46bc" class="i method">FromHandle</a>(<span class="r54 r">hIconEx</span>[0]).<a href="@0@System.Drawing/A.html#82bd640130ee6fad" class="i method">Clone</a>();

					<b>return</b> <span class="r56 r">extractedIcon</span>;
				}
				<b>else</b> <span class="c">//No icon read.</span>
					<b>return null</b>;
			}
			<b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r57 rd" class="r57 r">exc</span>)
			{
				<span class="c">//Extract icon error.</span>
				<b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#05c83504cb63f57a" class="t constructor">ApplicationException</a>
					(<span class="s">&quot;Could not extract icon&quot;</span>, <span class="r57 r">exc</span>);
			}
			<b>finally</b>
			{
				<span class="c">//Release resources.</span>
				<b>foreach</b> (<a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a> <span id="r58 rd" class="r58 r">ptr</span> <b>in</b> <span class="r54 r">hIconEx</span>)
					<b>if</b> (<span class="r58 r">ptr</span> != <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>.<a href="@0@mscorlib/A.html#d46202ed9b6005b2" class="i field">Zero</a>)
						<a href="#95644f64d622943c" class="i method">DestroyIcon</a>(<span class="r58 r">ptr</span>);

				<b>foreach</b> (<a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a> <span id="r59 rd" class="r59 r">ptr</span> <b>in</b> <span class="r53 r">hDummy</span>)
					<b>if</b> (<span class="r59 r">ptr</span> != <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>.<a href="@0@mscorlib/A.html#d46202ed9b6005b2" class="i field">Zero</a>)
						<a href="#95644f64d622943c" class="i method">DestroyIcon</a>(<span class="r59 r">ptr</span>);
			}
		}
		<span class="k preprocess">#</span><span class="k preprocess">endregion</span>

		<b>public static bool</b> <a id="3606dddbb285ac16" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">IsMac</a>(){
			<b>return</b> <a href="OSVersionEx.cs.html#9fe6b539828fce94" class="t t">OSVersionEx</a>.<a href="OSVersionEx.cs.html#ec6f3b2584ceac8c" class="i property">Platform</a> == <a href="@0@mscorlib/A.html#065a6a7be5e74336" class="t t">PlatformID</a>.<a href="@0@mscorlib/A.html#e8b92790a2a353a3" class="i field">MacOSX</a>;
		}
	}
}
</pre></td></tr></table></div></body></html>
