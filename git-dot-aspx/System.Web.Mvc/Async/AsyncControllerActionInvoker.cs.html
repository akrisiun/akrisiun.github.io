<!DOCTYPE html>
<html><head><title>AsyncControllerActionInvoker.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(529);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Web.Mvc/Async/AsyncControllerActionInvoker.cs" target="_top">Async\AsyncControllerActionInvoker.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Web.Mvc" target="_top">..\Mvc\src\System.Web.Mvc\System.Web.Mvc.csproj</a> (System.Web.Mvc)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Open Technologies, Inc. All rights reserved. See License.txt in the project root for license information.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i n">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i n">Contracts</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Security</span>.<span class="i n">Principal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Web</span>.<span class="i n">Mvc</span>.<span class="i n">Filters</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Web</span>.<span class="i n">Mvc</span>.<span class="i n">Routing</span>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Web</span>.<span class="i n">Mvc</span>.<span class="i n">Async</span>
{
    <b>public class</b> <a id="cf5963931509b82c" href="../R/cf5963931509b82c.html" target="n" data-glyph="0,0" class="t t"><span id="6be5ad4dfaa67ecb">AsyncControllerActionInvoker</span></a> : <a href="../ControllerActionInvoker.cs.html#5a6c0f31472d5b7b" class="t t">ControllerActionInvoker</a>, <a href="IAsyncActionInvoker.cs.html#19e8b834ee736369" class="t t">IAsyncActionInvoker</a>
    {
        <b>private static readonly object</b> <a id="a0a6de1694966122" href="../R/a0a6de1694966122.html" target="n" data-glyph="46,1" class="i field">_invokeActionTag</a> = <b>new</b> <b>object</b>();
        <b>private static readonly object</b> <a id="73719a88d885164e" href="../R/73719a88d885164e.html" target="n" data-glyph="46,1" class="i field">_invokeActionMethodTag</a> = <b>new</b> <b>object</b>();
        <b>private static readonly object</b> <a id="1c64bfa8e7db57e2" href="../R/1c64bfa8e7db57e2.html" target="n" data-glyph="46,1" class="i field">_invokeActionMethodWithFiltersTag</a> = <b>new</b> <b>object</b>();
 
        <b>protected async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>bool</b>&gt; <a id="c36c9223aa3a8282" href="../R/c36c9223aa3a8282.html" target="n" data-glyph="75,1" class="i method">InvokeActionAsync</a>(<a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r0 rd" class="r0 r">controllerContext</span>, <a href="../ActionDescriptor.cs.html#dcef6bdd6f885ebe" class="t t">ActionDescriptor</a> <span id="r1 rd" class="r1 r">actionDescriptor</span>)
        {
            <b>if</b> (<span class="r0 r">controllerContext</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<span class="s">&quot;controllerContext&quot;</span>);
            }
 
            <a href="../FilterInfo.cs.html#1eb870b4b16a459c" class="t t">FilterInfo</a> <span id="r2 rd" class="r2 r">filterInfo</span> = <a href="../ControllerActionInvoker.cs.html#720c2f51545ff88e" class="i method">GetFilters</a>(<span class="r0 r">controllerContext</span>, <span class="r1 r">actionDescriptor</span>);
            <a href="../ExceptionContext.cs.html#64e554bfeb46df68" class="t t">ExceptionContext</a> <span id="r3 rd" class="r3 r">exceptionContext</span> = <b>null</b>;
            <b>try</b>
            {
                <a href="../Filters/AuthenticationContext.cs.html#a6c73975929a7023" class="t t">AuthenticationContext</a> <span id="r4 rd" class="r4 r">authenticationContext</span> = <a href="../ControllerActionInvoker.cs.html#718a443092e4339a" class="i method">InvokeAuthenticationFilters</a>(<span class="r0 r">controllerContext</span>,
                    <span class="r2 r">filterInfo</span>.<a href="../FilterInfo.cs.html#a8619f09903851ad" class="i property">AuthenticationFilters</a>, <span class="r1 r">actionDescriptor</span>);
                <b>if</b> (<span class="r4 r">authenticationContext</span>.<a href="../Filters/AuthenticationContext.cs.html#11c81fb18bf2b8c1" class="i property">Result</a> != <b>null</b>)
                {
                    <span class="c">// An authentication filter signaled that we should short-circuit the request. Let all</span>
                    <span class="c">// authentication filters contribute to an action result (to combine authentication</span>
                    <span class="c">// challenges). Then, run this action result.</span>
                    <a href="../Filters/AuthenticationChallengeContext.cs.html#e92a90e211c320f0" class="t t">AuthenticationChallengeContext</a> <span id="r5 rd" class="r5 r">challengeContext</span> =
                        <a href="../ControllerActionInvoker.cs.html#9f878bb6bd04bee5" class="i method">InvokeAuthenticationFiltersChallenge</a>(<span class="r0 r">controllerContext</span>,
                        <span class="r2 r">filterInfo</span>.<a href="../FilterInfo.cs.html#a8619f09903851ad" class="i property">AuthenticationFilters</a>, <span class="r1 r">actionDescriptor</span>, <span class="r4 r">authenticationContext</span>.<a href="../Filters/AuthenticationContext.cs.html#11c81fb18bf2b8c1" class="i property">Result</a>);
                    <b>await</b> <a href="#efbbdf4f59647ee8" class="i method">InvokeActionResultAsync</a>(<span class="r0 r">controllerContext</span>,
                        <span class="r5 r">challengeContext</span>.<a href="../Filters/AuthenticationChallengeContext.cs.html#4db7db7f274fc752" class="i property">Result</a> ?? <span class="r4 r">authenticationContext</span>.<a href="../Filters/AuthenticationContext.cs.html#11c81fb18bf2b8c1" class="i property">Result</a>).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                }
                <b>else</b>
                {
                    <a href="../AuthorizationContext.cs.html#45e7db493539034a" class="t t">AuthorizationContext</a> <span id="r6 rd" class="r6 r">authorizationContext</span> = <a href="../ControllerActionInvoker.cs.html#f00e6812c9a3632f" class="i method">InvokeAuthorizationFilters</a>(<span class="r0 r">controllerContext</span>, <span class="r2 r">filterInfo</span>.<a href="../FilterInfo.cs.html#2755cb81dfbf1576" class="i property">AuthorizationFilters</a>, <span class="r1 r">actionDescriptor</span>);
                    <b>if</b> (<span class="r6 r">authorizationContext</span>.<a href="../AuthorizationContext.cs.html#a402086d855c7290" class="i property">Result</a> != <b>null</b>)
                    {
                        <span class="c">// An authorization filter signaled that we should short-circuit the request. Let all</span>
                        <span class="c">// authentication filters contribute to an action result (to combine authentication</span>
                        <span class="c">// challenges). Then, run this action result.</span>
                        <a href="../Filters/AuthenticationChallengeContext.cs.html#e92a90e211c320f0" class="t t">AuthenticationChallengeContext</a> <span id="r7 rd" class="r7 r">challengeContext</span> =
                            <a href="../ControllerActionInvoker.cs.html#9f878bb6bd04bee5" class="i method">InvokeAuthenticationFiltersChallenge</a>(<span class="r0 r">controllerContext</span>,
                            <span class="r2 r">filterInfo</span>.<a href="../FilterInfo.cs.html#a8619f09903851ad" class="i property">AuthenticationFilters</a>, <span class="r1 r">actionDescriptor</span>, <span class="r6 r">authorizationContext</span>.<a href="../AuthorizationContext.cs.html#a402086d855c7290" class="i property">Result</a>);
                        <b>await</b> <a href="#efbbdf4f59647ee8" class="i method">InvokeActionResultAsync</a>(<span class="r0 r">controllerContext</span>,
                            <span class="r7 r">challengeContext</span>.<a href="../Filters/AuthenticationChallengeContext.cs.html#4db7db7f274fc752" class="i property">Result</a> ?? <span class="r6 r">authorizationContext</span>.<a href="../AuthorizationContext.cs.html#a402086d855c7290" class="i property">Result</a>).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                    }
                    <b>else</b>
                    {
                        <b>if</b> (<span class="r0 r">controllerContext</span>.<a href="../ControllerContext.cs.html#722f9acba70af924" class="i property">Controller</a>.<a href="../ControllerBase.cs.html#39c34750f1305927" class="i property">ValidateRequest</a>)
                        {
                            <a href="../ControllerActionInvoker.cs.html#1b5d4daac6ff5292" class="i method">ValidateRequest</a>(<span class="r0 r">controllerContext</span>);
                        }
 
                        <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<b>string</b>, <b>object</b>&gt; <span id="r8 rd" class="r8 r">parameters</span> = <a href="../ControllerActionInvoker.cs.html#189132716962b865" class="i method">GetParameterValues</a>(<span class="r0 r">controllerContext</span>, <span class="r1 r">actionDescriptor</span>);
                        <a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a> <span id="r9 rd" class="r9 r">postActionContext</span> = 
                            <b>await</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a>&gt;.<a href="@0@mscorlib/A.html#c985882d7d04413c" class="i property">Factory</a>.<a href="@0@mscorlib/A.html#e76bf0632e9f1558" class="i method">FromAsync</a>(
                                <b>delegate</b>(<a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r10 rd" class="r10 r">asyncCallback</span>, <b>object</b> <span id="r11 rd" class="r11 r">asyncState</span>)
                                {
                                    <b>return</b> <a href="#a921614a71c60bfa" class="i method">BeginInvokeActionMethodWithFilters</a>(<span class="r0 r">controllerContext</span>, <span class="r2 r">filterInfo</span>.<a href="../FilterInfo.cs.html#d95633ced4357150" class="i property">ActionFilters</a>, <span class="r1 r">actionDescriptor</span>, <span class="r8 r">parameters</span>, <span class="r10 r">asyncCallback</span>, <span class="r11 r">asyncState</span>);
                                },
                                <a href="#0111401514ea563e" class="i method">EndInvokeActionMethodWithFilters</a>, 
                                <b>null</b>);
                        <span class="c">// The action succeeded. Let all authentication filters contribute to an action</span>
                        <span class="c">// result (to combine authentication challenges; some authentication filters need</span>
                        <span class="c">// to do negotiation even on a successful result). Then, run this action result.</span>
                        <a href="../Filters/AuthenticationChallengeContext.cs.html#e92a90e211c320f0" class="t t">AuthenticationChallengeContext</a> <span id="r12 rd" class="r12 r">challengeContext</span> =
                            <a href="../ControllerActionInvoker.cs.html#9f878bb6bd04bee5" class="i method">InvokeAuthenticationFiltersChallenge</a>(<span class="r0 r">controllerContext</span>,
                            <span class="r2 r">filterInfo</span>.<a href="../FilterInfo.cs.html#a8619f09903851ad" class="i property">AuthenticationFilters</a>, <span class="r1 r">actionDescriptor</span>,
                            <span class="r9 r">postActionContext</span>.<a href="../ActionExecutedContext.cs.html#26fe45b16618eee9" class="i property">Result</a>);
                        <b>await</b> <a href="#553edeeba00a1404" class="i method">InvokeActionResultWithFiltersAsync</a>(<span class="r0 r">controllerContext</span>, <span class="r2 r">filterInfo</span>.<a href="../FilterInfo.cs.html#ec4d431f980dbfd6" class="i property">ResultFilters</a>,
                            <span class="r12 r">challengeContext</span>.<a href="../Filters/AuthenticationChallengeContext.cs.html#4db7db7f274fc752" class="i property">Result</a> ?? <span class="r9 r">postActionContext</span>.<a href="../ActionExecutedContext.cs.html#26fe45b16618eee9" class="i property">Result</a>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
                    }
                }
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#1b47a5a85e0d5883" class="t t">ThreadAbortException</a>)
            {
                <span class="c">// This type of exception occurs as a result of Response.Redirect(), but we special-case so that</span>
                <span class="c">// the filters don&#39;t see this as an error.</span>
                <b>throw</b>;
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r13 rd" class="r13 r">ex</span>)
            {
                <span class="c">// something blew up, so execute the exception filters</span>
                <span class="r3 r">exceptionContext</span> = <a href="../ControllerActionInvoker.cs.html#169df7312216009d" class="i method">InvokeExceptionFilters</a>(<span class="r0 r">controllerContext</span>, <span class="r2 r">filterInfo</span>.<a href="../FilterInfo.cs.html#48484d74b12cf2e6" class="i property">ExceptionFilters</a>, <span class="r13 r">ex</span>);
                <b>if</b> (!<span class="r3 r">exceptionContext</span>.<a href="../ExceptionContext.cs.html#e2b91239a2061db3" class="i property">ExceptionHandled</a>)
                {
                    <b>throw</b>;
                }
            }
            <b>if</b> (<span class="r3 r">exceptionContext</span> != <b>null</b>)
            {
                <b>await</b> <a href="#efbbdf4f59647ee8" class="i method">InvokeActionResultAsync</a>(<span class="r0 r">controllerContext</span>, <span class="r3 r">exceptionContext</span>.<a href="../ExceptionContext.cs.html#8dbedbd00c7189dc" class="i property">Result</a>).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
            <b>return true</b>;
        }
 
        <b>protected virtual</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="efbbdf4f59647ee8" href="../R/efbbdf4f59647ee8.html" target="n" data-glyph="75,1" class="i method">InvokeActionResultAsync</a>(<a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r14 rd" class="r14 r">controllerContext</span>, <a href="../ActionResult.cs.html#8bbb8ceda32fbb12" class="t t">ActionResult</a> <span id="r15 rd" class="r15 r">actionResult</span>)
        {
            <b>return</b> <span class="r15 r">actionResult</span>.<a href="../ActionResult.cs.html#d0db708d662ca1cf" class="i method">ExecuteResultAsync</a>(<span class="r14 r">controllerContext</span>);
        }
 
        <b>protected virtual</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="../ResultExecutedContext.cs.html#ead256ea27cbc548" class="t t">ResultExecutedContext</a>&gt; <a id="553edeeba00a1404" href="../R/553edeeba00a1404.html" target="n" data-glyph="75,1" class="i method">InvokeActionResultWithFiltersAsync</a>(<a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r16 rd" class="r16 r">controllerContext</span>, <a href="@0@mscorlib/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="../IResultFilter.cs.html#1455e64ef815b72b" class="t t">IResultFilter</a>&gt; <span id="r17 rd" class="r17 r">filters</span>, <a href="../ActionResult.cs.html#8bbb8ceda32fbb12" class="t t">ActionResult</a> <span id="r18 rd" class="r18 r">actionResult</span>)
        {
            <a href="../ResultExecutingContext.cs.html#70779de1a7fe6836" class="t t">ResultExecutingContext</a> <span id="r19 rd" class="r19 r">preContext</span> = <b>new</b> <a href="../ResultExecutingContext.cs.html#dcaec38b230363ae" class="t constructor">ResultExecutingContext</a>(<span class="r16 r">controllerContext</span>, <span class="r18 r">actionResult</span>);
 
            <b>int</b> <span id="r20 rd" class="r20 r">startingFilterIndex</span> = 0;
            <b>return</b> <a href="#f117865de039e615" class="i method">InvokeActionResultFilterRecursiveAsync</a>(<span class="r17 r">filters</span>, <span class="r20 r">startingFilterIndex</span>, <span class="r19 r">preContext</span>, <span class="r16 r">controllerContext</span>, <span class="r18 r">actionResult</span>);
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="../ResultExecutedContext.cs.html#ead256ea27cbc548" class="t t">ResultExecutedContext</a>&gt; <a id="f117865de039e615" href="../R/f117865de039e615.html" target="n" data-glyph="76,1" class="i method">InvokeActionResultFilterRecursiveAsync</a>(<a href="@0@mscorlib/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="../IResultFilter.cs.html#1455e64ef815b72b" class="t t">IResultFilter</a>&gt; <span id="r21 rd" class="r21 r">filters</span>, <b>int</b> <span id="r22 rd" class="r22 r">filterIndex</span>, <a href="../ResultExecutingContext.cs.html#70779de1a7fe6836" class="t t">ResultExecutingContext</a> <span id="r23 rd" class="r23 r">preContext</span>, <a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r24 rd" class="r24 r">controllerContext</span>, <a href="../ActionResult.cs.html#8bbb8ceda32fbb12" class="t t">ActionResult</a> <span id="r25 rd" class="r25 r">actionResult</span>)
        {
            <span class="c">// Performance-sensitive</span>
 
            <span class="c">// For compatbility, the following behavior must be maintained</span>
            <span class="c">//   The OnResultExecuting events must fire in forward order</span>
            <span class="c">//   The InvokeActionResultAsync must then fire</span>
            <span class="c">//   The OnResultExecuted events must fire in reverse order</span>
            <span class="c">//   Earlier filters can process the results and exceptions from the handling of later filters</span>
            <span class="c">// This is achieved by calling recursively and moving through the filter list forwards</span>
 
            <span class="c">// If there are no more filters to recurse over, create the main result</span>
            <b>if</b> (<span class="r22 r">filterIndex</span> &gt; <span class="r21 r">filters</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> - 1)
            {
                <b>await</b> <a href="#efbbdf4f59647ee8" class="i method">InvokeActionResultAsync</a>(<span class="r24 r">controllerContext</span>, <span class="r25 r">actionResult</span>).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                <b>return</b> <b>new</b> <a href="../ResultExecutedContext.cs.html#33010b5558da9718" class="t constructor">ResultExecutedContext</a>(<span class="r24 r">controllerContext</span>, <span class="r25 r">actionResult</span>, <span class="r26 r">canceled</span>: <b>false</b>, <span class="r27 r">exception</span>: <b>null</b>);
            }
 
            <span class="c">// Otherwise process the filters recursively</span>
            <a href="../IResultFilter.cs.html#1455e64ef815b72b" class="t t">IResultFilter</a> <span id="r28 rd" class="r28 r">filter</span> = <span class="r21 r">filters</span><a href="@0@mscorlib/A.html#396bb785d31f5979">[</a><span class="r22 r">filterIndex</span>];
            <span class="r28 r">filter</span>.<a href="../IResultFilter.cs.html#172b334c83b84555" class="i method">OnResultExecuting</a>(<span class="r23 r">preContext</span>);
            <b>if</b> (<span class="r23 r">preContext</span>.<a href="../ResultExecutingContext.cs.html#7d56c85db96a3f04" class="i property">Cancel</a>)
            {
                <b>return</b> <b>new</b> <a href="../ResultExecutedContext.cs.html#33010b5558da9718" class="t constructor">ResultExecutedContext</a>(<span class="r23 r">preContext</span>, <span class="r23 r">preContext</span>.<a href="../ResultExecutingContext.cs.html#96d8d4ab3f9b20c8" class="i property">Result</a>, <span class="r26 r">canceled</span>: <b>true</b>, <span class="r27 r">exception</span>: <b>null</b>);
            }
 
            <b>bool</b> <span id="r29 rd" class="r29 r">wasError</span> = <b>false</b>;
            <a href="../ResultExecutedContext.cs.html#ead256ea27cbc548" class="t t">ResultExecutedContext</a> <span id="r30 rd" class="r30 r">postContext</span> = <b>null</b>;
            <b>try</b>
            {
                <span class="c">// Use the filters in forward direction</span>
                <b>int</b> <span id="r31 rd" class="r31 r">nextFilterIndex</span> = <span class="r22 r">filterIndex</span> + 1;
                <span class="r30 r">postContext</span> = <b>await</b> <a href="#f117865de039e615" class="i method">InvokeActionResultFilterRecursiveAsync</a>(<span class="r21 r">filters</span>, <span class="r31 r">nextFilterIndex</span>, <span class="r23 r">preContext</span>, <span class="r24 r">controllerContext</span>, <span class="r25 r">actionResult</span>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#1b47a5a85e0d5883" class="t t">ThreadAbortException</a>)
            {
                <span class="c">// This type of exception occurs as a result of Response.Redirect(), but we special-case so that</span>
                <span class="c">// the filters don&#39;t see this as an error.</span>
                <span class="r30 r">postContext</span> = <b>new</b> <a href="../ResultExecutedContext.cs.html#33010b5558da9718" class="t constructor">ResultExecutedContext</a>(<span class="r23 r">preContext</span>, <span class="r23 r">preContext</span>.<a href="../ResultExecutingContext.cs.html#96d8d4ab3f9b20c8" class="i property">Result</a>, <span class="r26 r">canceled</span>: <b>false</b>, <span class="r27 r">exception</span>: <b>null</b>);
                <span class="r28 r">filter</span>.<a href="../IResultFilter.cs.html#c2215e8e79bc71e5" class="i method">OnResultExecuted</a>(<span class="r30 r">postContext</span>);
                <b>throw</b>;
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r32 rd" class="r32 r">ex</span>)
            {
                <span class="r29 r">wasError</span> = <b>true</b>;
                <span class="r30 r">postContext</span> = <b>new</b> <a href="../ResultExecutedContext.cs.html#33010b5558da9718" class="t constructor">ResultExecutedContext</a>(<span class="r23 r">preContext</span>, <span class="r23 r">preContext</span>.<a href="../ResultExecutingContext.cs.html#96d8d4ab3f9b20c8" class="i property">Result</a>, <span class="r26 r">canceled</span>: <b>false</b>, <span class="r27 r">exception</span>: <span class="r32 r">ex</span>);
                <span class="r28 r">filter</span>.<a href="../IResultFilter.cs.html#c2215e8e79bc71e5" class="i method">OnResultExecuted</a>(<span class="r30 r">postContext</span>);
                <b>if</b> (!<span class="r30 r">postContext</span>.<a href="../ResultExecutedContext.cs.html#8ca35aba18714b63" class="i property">ExceptionHandled</a>)
                {
                    <b>throw</b>;
                }
            }
            <b>if</b> (!<span class="r29 r">wasError</span>)
            {
                <span class="r28 r">filter</span>.<a href="../IResultFilter.cs.html#c2215e8e79bc71e5" class="i method">OnResultExecuted</a>(<span class="r30 r">postContext</span>);
            }
            <b>return</b> <span class="r30 r">postContext</span>;
        }
 
        [<a href="@0@mscorlib/A.html#5e00de6576fb9ce7" class="t constructor">SuppressMessage</a>(<span class="s">&quot;Microsoft.Maintainability&quot;</span>, <span class="s">&quot;CA1506:AvoidExcessiveClassCoupling&quot;</span>, <a href="@0@mscorlib/A.html#ce02a652a479502a" class="i property">Justification</a> = <span class="s">&quot;Refactoring to reduce coupling not currently justified.&quot;</span>)]
        [<a href="@0@mscorlib/A.html#5e00de6576fb9ce7" class="t constructor">SuppressMessage</a>(<span class="s">&quot;Microsoft.Web.FxCop&quot;</span>, <span class="s">&quot;MW1201:DoNotCallProblematicMethodsOnTask&quot;</span>, <a href="@0@mscorlib/A.html#ce02a652a479502a" class="i property">Justification</a> = <span class="s">&quot;Task-based async wrapper.&quot;</span>)]
        [<a href="@0@mscorlib/A.html#5e00de6576fb9ce7" class="t constructor">SuppressMessage</a>(<span class="s">&quot;Microsoft.Web.FxCop&quot;</span>, <span class="s">&quot;MW1202:DoNotUseProblematicTaskTypes&quot;</span>, <a href="@0@mscorlib/A.html#ce02a652a479502a" class="i property">Justification</a> = <span class="s">&quot;Task-based async wrapper.&quot;</span>)]
        <b>public virtual</b> <a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <a id="e10d6234bc783885" href="../R/e10d6234bc783885.html" target="n" data-glyph="72,1" class="i method">BeginInvokeAction</a>(<a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r33 rd" class="r33 r">controllerContext</span>, <b>string</b> <span id="r34 rd" class="r34 r">actionName</span>, <a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r35 rd" class="r35 r">callback</span>, <b>object</b> <span id="r36 rd" class="r36 r">state</span>)
        {
            <b>if</b> (<span class="r33 r">controllerContext</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<span class="s">&quot;controllerContext&quot;</span>);
            }
 
            <a href="@0@mscorlib/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@0@mscorlib/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r33 r">controllerContext</span>.<a href="../ControllerContext.cs.html#754ac1d20a65feb7" class="i property">RouteData</a> != <b>null</b>);
            <b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r34 r">actionName</span>) &amp;&amp; !<span class="r33 r">controllerContext</span>.<a href="../ControllerContext.cs.html#754ac1d20a65feb7" class="i property">RouteData</a>.<a href="../Routing/DirectRouteExtensions.cs.html#41dece4c48b2a131" class="i method">HasDirectRouteMatch</a>())
            {
                <b>throw</b> <a href="../Error.cs.html#99b77324465ca7fb" class="t t">Error</a>.<a href="../Error.cs.html#1d47f3d5072367d1" class="i method">ParameterCannotBeNullOrEmpty</a>(<span class="s">&quot;actionName&quot;</span>);
            }
 
            <a href="../ControllerDescriptor.cs.html#20202e8261f37923" class="t t">ControllerDescriptor</a> <span id="r37 rd" class="r37 r">controllerDescriptor</span> = <a href="#bac5f0fefcdcc18b" class="i method">GetControllerDescriptor</a>(<span class="r33 r">controllerContext</span>);
            <a href="../ActionDescriptor.cs.html#dcef6bdd6f885ebe" class="t t">ActionDescriptor</a> <span id="r38 rd" class="r38 r">actionDescriptor</span> = <a href="../ControllerActionInvoker.cs.html#de642aa4c08b9b2f" class="i method">FindAction</a>(<span class="r33 r">controllerContext</span>, <span class="r37 r">controllerDescriptor</span>, <span class="r34 r">actionName</span>);
            <b>if</b> (<span class="r38 r">actionDescriptor</span> != <b>null</b>)
            {
                <a href="BeginInvokeDelegate.cs.html#5c7a29f52a82f9df" class="t t">BeginInvokeDelegate</a> <span id="r39 rd" class="r39 r">beginDelegate</span> = <b>delegate</b>(<a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r40 rd" class="r40 r">asyncCallback</span>, <b>object</b> <span id="r41 rd" class="r41 r">asyncState</span>)
                {
                    <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="k">var</a> <span id="r42 rd" class="r42 r">task</span> = <a href="#c36c9223aa3a8282" class="i method">InvokeActionAsync</a>(<span class="r33 r">controllerContext</span>, <span class="r38 r">actionDescriptor</span>);
                    <a href="@0@mscorlib/A.html#94bf04047d6bd325" class="k">var</a> <span id="r43 rd" class="r43 r">tcs</span> = <b>new</b> <a href="@0@mscorlib/A.html#14fdf40c28ffb246" class="t constructor">TaskCompletionSource</a>&lt;<b>bool</b>&gt;(<span class="r41 r">asyncState</span>);
                    <span class="r42 r">task</span>.<a href="@0@mscorlib/A.html#c575412f0ddc76f8" class="i method">ContinueWith</a>(<span id="r44 rd" class="r44 r">t</span> =&gt;
                    {
                        <b>if</b> (<span class="r44 r">t</span>.<a href="@0@mscorlib/A.html#e9c0495c4af4d4df" class="i property">IsFaulted</a>)
                        {
                            <span class="r43 r">tcs</span>.<a href="@0@mscorlib/A.html#4da85e9e37e59e0b" class="i method">TrySetException</a>(<span class="r44 r">t</span>.<a href="@0@mscorlib/A.html#0bdc783f2cd45895" class="i property">Exception</a>.<a href="@0@mscorlib/A.html#e9d864767768da2b" class="i property">InnerExceptions</a>);
                        }
                        <b>else if</b> (<span class="r44 r">t</span>.<a href="@0@mscorlib/A.html#37cd1e11bb77b197" class="i property">IsCanceled</a>)
                        {
                            <span class="r43 r">tcs</span>.<a href="@0@mscorlib/A.html#2ad1d0e86fe6c98d" class="i method">TrySetCanceled</a>();
                        }
                        <b>else</b>
                        {
                            <span class="r43 r">tcs</span>.<a href="@0@mscorlib/A.html#f58e440930617bf6" class="i method">TrySetResult</a>(<span class="r44 r">t</span>.<a href="@0@mscorlib/A.html#826690b09f24e719" class="i property">Result</a>);
                        }
                        <b>if</b> (<span class="r40 r">asyncCallback</span> != <b>null</b>)
                        {
                            <span class="r40 r">asyncCallback</span>(<span class="r43 r">tcs</span>.<a href="@0@mscorlib/A.html#14fe3876fba4607a" class="i property">Task</a>);
                        }
                    }, <a href="@0@mscorlib/A.html#a13039cb7befff52" class="t t">TaskContinuationOptions</a>.<a href="@0@mscorlib/A.html#2dd80c4cf8651fce" class="i field">ExecuteSynchronously</a>);
                    <b>return</b> <span class="r43 r">tcs</span>.<a href="@0@mscorlib/A.html#14fe3876fba4607a" class="i property">Task</a>;
                };
                <a href="EndInvokeDelegateOfTResult.cs.html#1c562eefa4a3dd45" class="t t">EndInvokeDelegate</a>&lt;<b>bool</b>&gt; <span id="r45 rd" class="r45 r">endDelegate</span> = <b>delegate</b>(<a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <span id="r46 rd" class="r46 r">asyncResult</span>)
                {
                    <b>return</b> ((<a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>bool</b>&gt;)<span class="r46 r">asyncResult</span>).<a href="@0@mscorlib/A.html#e1d639f68b66715a" class="i method">GetAwaiter</a>().<a href="@0@mscorlib/A.html#c2597ba59f71d619" class="i method">GetResult</a>();
                };
                <b>return</b> <a href="AsyncResultWrapper.cs.html#ce8fa429970377d1" class="t t">AsyncResultWrapper</a>.<a href="AsyncResultWrapper.cs.html#82ae33357ebb3e05" class="i method">Begin</a>(<span class="r35 r">callback</span>, <span class="r36 r">state</span>, <span class="r39 r">beginDelegate</span>, <span class="r45 r">endDelegate</span>, <a href="#a0a6de1694966122" class="i field">_invokeActionTag</a>);
            }
            <b>else</b>
            {
                <span class="c">// Notify the controller that no action was found.</span>
                <b>return</b> <a href="#a00f406226fffa87" class="i method">BeginInvokeAction_ActionNotFound</a>(<span class="r35 r">callback</span>, <span class="r36 r">state</span>);
            }
        }
 
        <b>private static</b> <a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <a id="a00f406226fffa87" href="../R/a00f406226fffa87.html" target="n" data-glyph="76,1" class="i method">BeginInvokeAction_ActionNotFound</a>(<a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r47 rd" class="r47 r">callback</span>, <b>object</b> <span id="r48 rd" class="r48 r">state</span>)
        {
            <a href="BeginInvokeDelegate.cs.html#5c7a29f52a82f9df" class="t t">BeginInvokeDelegate</a> <span id="r49 rd" class="r49 r">beginDelegate</span> = <a href="#f50026a7cf108c56" class="i method">BeginInvokeAction_MakeSynchronousAsyncResult</a>;
 
            <a href="EndInvokeDelegateOfTResult.cs.html#1c562eefa4a3dd45" class="t t">EndInvokeDelegate</a>&lt;<b>bool</b>&gt; <span id="r50 rd" class="r50 r">endDelegate</span> = <b>delegate</b>(<a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <span id="r51 rd" class="r51 r">asyncResult</span>)
            {
                <b>return false</b>;
            };
 
            <b>return</b> <a href="AsyncResultWrapper.cs.html#ce8fa429970377d1" class="t t">AsyncResultWrapper</a>.<a href="AsyncResultWrapper.cs.html#82ae33357ebb3e05" class="i method">Begin</a>(<span class="r47 r">callback</span>, <span class="r48 r">state</span>, <span class="r49 r">beginDelegate</span>, <span class="r50 r">endDelegate</span>, <a href="#a0a6de1694966122" class="i field">_invokeActionTag</a>);
        }
 
        <b>private static</b> <a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <a id="f50026a7cf108c56" href="../R/f50026a7cf108c56.html" target="n" data-glyph="76,1" class="i method">BeginInvokeAction_MakeSynchronousAsyncResult</a>(<a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r52 rd" class="r52 r">callback</span>, <b>object</b> <span id="r53 rd" class="r53 r">state</span>)
        {
            <a href="SimpleAsyncResult.cs.html#d86bc59924ce9f73" class="t t">SimpleAsyncResult</a> <span id="r54 rd" class="r54 r">asyncResult</span> = <b>new</b> <a href="SimpleAsyncResult.cs.html#a2781005234fe167" class="t constructor">SimpleAsyncResult</a>(<span class="r53 r">state</span>);
            <span class="r54 r">asyncResult</span>.<a href="SimpleAsyncResult.cs.html#7df4c15734c7b90f" class="i method">MarkCompleted</a>(<b>true</b> <span class="c">/* completedSynchronously */</span>, <span class="r52 r">callback</span>);
            <b>return</b> <span class="r54 r">asyncResult</span>;
        }
 
        <b>protected internal virtual</b> <a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <a id="4ac5de6d8d3e1383" href="../R/4ac5de6d8d3e1383.html" target="n" data-glyph="75,1" class="i method">BeginInvokeActionMethod</a>(<a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r55 rd" class="r55 r">controllerContext</span>, <a href="../ActionDescriptor.cs.html#dcef6bdd6f885ebe" class="t t">ActionDescriptor</a> <span id="r56 rd" class="r56 r">actionDescriptor</span>, <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<b>string</b>, <b>object</b>&gt; <span id="r57 rd" class="r57 r">parameters</span>, <a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r58 rd" class="r58 r">callback</span>, <b>object</b> <span id="r59 rd" class="r59 r">state</span>)
        {
            <a href="AsyncActionDescriptor.cs.html#0749997528b19400" class="t t">AsyncActionDescriptor</a> <span id="r60 rd" class="r60 r">asyncActionDescriptor</span> = <span class="r56 r">actionDescriptor</span> <b>as</b> <a href="AsyncActionDescriptor.cs.html#0749997528b19400" class="t t">AsyncActionDescriptor</a>;
            <b>if</b> (<span class="r60 r">asyncActionDescriptor</span> != <b>null</b>)
            {
                <b>return</b> <a href="#687985b7c63b7b7d" class="i method">BeginInvokeAsynchronousActionMethod</a>(<span class="r55 r">controllerContext</span>, <span class="r60 r">asyncActionDescriptor</span>, <span class="r57 r">parameters</span>, <span class="r58 r">callback</span>, <span class="r59 r">state</span>);
            }
            <b>else</b>
            {
                <b>return</b> <a href="#a4824c0905145596" class="i method">BeginInvokeSynchronousActionMethod</a>(<span class="r55 r">controllerContext</span>, <span class="r56 r">actionDescriptor</span>, <span class="r57 r">parameters</span>, <span class="r58 r">callback</span>, <span class="r59 r">state</span>);
            }
        }
 
        <b>protected internal virtual</b> <a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <a id="a921614a71c60bfa" href="../R/a921614a71c60bfa.html" target="n" data-glyph="75,1" class="i method">BeginInvokeActionMethodWithFilters</a>(<a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r61 rd" class="r61 r">controllerContext</span>, <a href="@0@mscorlib/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="../IActionFilter.cs.html#11570d9642b3eeee" class="t t">IActionFilter</a>&gt; <span id="r62 rd" class="r62 r">filters</span>, <a href="../ActionDescriptor.cs.html#dcef6bdd6f885ebe" class="t t">ActionDescriptor</a> <span id="r63 rd" class="r63 r">actionDescriptor</span>, <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<b>string</b>, <b>object</b>&gt; <span id="r64 rd" class="r64 r">parameters</span>, <a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r65 rd" class="r65 r">callback</span>, <b>object</b> <span id="r66 rd" class="r66 r">state</span>)
        {
            <a href="@0@mscorlib/A.html#87d60abb7092d5a4" class="t t">Func</a>&lt;<a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a>&gt; <span id="r67 rd" class="r67 r">endContinuation</span> = <b>null</b>;
 
            <a href="BeginInvokeDelegate.cs.html#5c7a29f52a82f9df" class="t t">BeginInvokeDelegate</a> <span id="r68 rd" class="r68 r">beginDelegate</span> = <b>delegate</b>(<a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r69 rd" class="r69 r">asyncCallback</span>, <b>object</b> <span id="r70 rd" class="r70 r">asyncState</span>)
            {
                <a href="#364eef058aebec55" class="t t">AsyncInvocationWithFilters</a> <span id="r71 rd" class="r71 r">invocation</span> = <b>new</b> <a href="#c9d261d7b955456d" class="t constructor">AsyncInvocationWithFilters</a>(<a href="#cf5963931509b82c" class="k">this</a>, <span class="r61 r">controllerContext</span>, <span class="r63 r">actionDescriptor</span>, <span class="r62 r">filters</span>, <span class="r64 r">parameters</span>, <span class="r69 r">asyncCallback</span>, <span class="r70 r">asyncState</span>);
 
                <b>const int</b> <span id="r72 rd" class="r72 r">StartingFilterIndex</span> = 0;
                <span class="r67 r">endContinuation</span> = <span class="r71 r">invocation</span>.<a href="#fde15367e8d5d8ba" class="i method">InvokeActionMethodFilterAsynchronouslyRecursive</a>(<span class="r72 r">StartingFilterIndex</span>);
 
                <b>if</b> (<span class="r71 r">invocation</span>.<a href="#802a9340ff44bb89" class="i field">InnerAsyncResult</a> != <b>null</b>)
                {
                    <span class="c">// we&#39;re just waiting for the inner result to complete</span>
                    <b>return</b> <span class="r71 r">invocation</span>.<a href="#802a9340ff44bb89" class="i field">InnerAsyncResult</a>;
                }
                <b>else</b>
                {
                    <span class="c">// something was short-circuited and the action was not called, so this was a synchronous operation</span>
                    <a href="SimpleAsyncResult.cs.html#d86bc59924ce9f73" class="t t">SimpleAsyncResult</a> <span id="r73 rd" class="r73 r">newAsyncResult</span> = <b>new</b> <a href="SimpleAsyncResult.cs.html#a2781005234fe167" class="t constructor">SimpleAsyncResult</a>(<span class="r70 r">asyncState</span>);
                    <span class="r73 r">newAsyncResult</span>.<a href="SimpleAsyncResult.cs.html#7df4c15734c7b90f" class="i method">MarkCompleted</a>(<span class="r74 r">completedSynchronously</span>: <b>true</b>, <span class="r75 r">callback</span>: <span class="r69 r">asyncCallback</span>);
                    <b>return</b> <span class="r73 r">newAsyncResult</span>;
                }
            };
 
            <a href="EndInvokeDelegateOfTResult.cs.html#1c562eefa4a3dd45" class="t t">EndInvokeDelegate</a>&lt;<a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a>&gt; <span id="r76 rd" class="r76 r">endDelegate</span> = <b>delegate</b>(<a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <span id="r77 rd" class="r77 r">asyncResult</span>)
            {
                <b>return</b> <span class="r67 r">endContinuation</span>();
            };
 
            <b>return</b> <a href="AsyncResultWrapper.cs.html#ce8fa429970377d1" class="t t">AsyncResultWrapper</a>.<a href="AsyncResultWrapper.cs.html#82ae33357ebb3e05" class="i method">Begin</a>(<span class="r65 r">callback</span>, <span class="r66 r">state</span>, <span class="r68 r">beginDelegate</span>, <span class="r76 r">endDelegate</span>, <a href="#1c64bfa8e7db57e2" class="i field">_invokeActionMethodWithFiltersTag</a>);
        }
 
        <b>private</b> <a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <a id="687985b7c63b7b7d" href="../R/687985b7c63b7b7d.html" target="n" data-glyph="76,1" class="i method">BeginInvokeAsynchronousActionMethod</a>(<a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r78 rd" class="r78 r">controllerContext</span>, <a href="AsyncActionDescriptor.cs.html#0749997528b19400" class="t t">AsyncActionDescriptor</a> <span id="r79 rd" class="r79 r">actionDescriptor</span>, <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<b>string</b>, <b>object</b>&gt; <span id="r80 rd" class="r80 r">parameters</span>, <a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r81 rd" class="r81 r">callback</span>, <b>object</b> <span id="r82 rd" class="r82 r">state</span>)
        {
            <a href="BeginInvokeDelegate.cs.html#5c7a29f52a82f9df" class="t t">BeginInvokeDelegate</a> <span id="r83 rd" class="r83 r">beginDelegate</span> = <b>delegate</b>(<a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r84 rd" class="r84 r">asyncCallback</span>, <b>object</b> <span id="r85 rd" class="r85 r">asyncState</span>)
            {
                <b>return</b> <span class="r79 r">actionDescriptor</span>.<a href="AsyncActionDescriptor.cs.html#0190d792ffd509d3" class="i method">BeginExecute</a>(<span class="r78 r">controllerContext</span>, <span class="r80 r">parameters</span>, <span class="r84 r">asyncCallback</span>, <span class="r85 r">asyncState</span>);
            };
 
            <a href="EndInvokeDelegateOfTResult.cs.html#1c562eefa4a3dd45" class="t t">EndInvokeDelegate</a>&lt;<a href="../ActionResult.cs.html#8bbb8ceda32fbb12" class="t t">ActionResult</a>&gt; <span id="r86 rd" class="r86 r">endDelegate</span> = <b>delegate</b>(<a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <span id="r87 rd" class="r87 r">asyncResult</span>)
            {
                <b>object</b> <span id="r88 rd" class="r88 r">returnValue</span> = <span class="r79 r">actionDescriptor</span>.<a href="AsyncActionDescriptor.cs.html#4ff5d9c1c60eefa5" class="i method">EndExecute</a>(<span class="r87 r">asyncResult</span>);
                <a href="../ActionResult.cs.html#8bbb8ceda32fbb12" class="t t">ActionResult</a> <span id="r89 rd" class="r89 r">result</span> = <a href="../ControllerActionInvoker.cs.html#2b905ecaf375b9f4" class="i method">CreateActionResult</a>(<span class="r78 r">controllerContext</span>, <span class="r79 r">actionDescriptor</span>, <span class="r88 r">returnValue</span>);
                <b>return</b> <span class="r89 r">result</span>;
            };
 
            <b>return</b> <a href="AsyncResultWrapper.cs.html#ce8fa429970377d1" class="t t">AsyncResultWrapper</a>.<a href="AsyncResultWrapper.cs.html#82ae33357ebb3e05" class="i method">Begin</a>(<span class="r81 r">callback</span>, <span class="r82 r">state</span>, <span class="r83 r">beginDelegate</span>, <span class="r86 r">endDelegate</span>, <a href="#73719a88d885164e" class="i field">_invokeActionMethodTag</a>);
        }
 
        <b>private</b> <a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <a id="a4824c0905145596" href="../R/a4824c0905145596.html" target="n" data-glyph="76,1" class="i method">BeginInvokeSynchronousActionMethod</a>(<a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r90 rd" class="r90 r">controllerContext</span>, <a href="../ActionDescriptor.cs.html#dcef6bdd6f885ebe" class="t t">ActionDescriptor</a> <span id="r91 rd" class="r91 r">actionDescriptor</span>, <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<b>string</b>, <b>object</b>&gt; <span id="r92 rd" class="r92 r">parameters</span>, <a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r93 rd" class="r93 r">callback</span>, <b>object</b> <span id="r94 rd" class="r94 r">state</span>)
        {
            <span class="c">// Frequently called so ensure delegate remains static and arguments do not allocate</span>
            <a href="EndInvokeDelegateOfTResultTState.cs.html#0d7aa5f2ea94a4a1" class="t t">EndInvokeDelegate</a>&lt;<a href="#6e8a72a3d4ad3a98" class="t t">ActionInvocation</a>, <a href="../ActionResult.cs.html#8bbb8ceda32fbb12" class="t t">ActionResult</a>&gt; <span id="r95 rd" class="r95 r">endInvokeFunc</span> = (<span id="r96 rd" class="r96 r">asyncResult</span>, <span id="r97 rd" class="r97 r">innerInvokeState</span>) =&gt;
                {
                    <b>return</b> <span class="r97 r">innerInvokeState</span>.<a href="#a42648f5c486b429" class="i method">InvokeSynchronousActionMethod</a>();
                };
            <a href="#6e8a72a3d4ad3a98" class="t t">ActionInvocation</a> <span id="r98 rd" class="r98 r">endInvokeState</span> = <b>new</b> <a href="#92110b7b29f2307f" class="t constructor">ActionInvocation</a>(<a href="#cf5963931509b82c" class="k">this</a>, <span class="r90 r">controllerContext</span>, <span class="r91 r">actionDescriptor</span>, <span class="r92 r">parameters</span>);
            <b>return</b> <a href="AsyncResultWrapper.cs.html#ce8fa429970377d1" class="t t">AsyncResultWrapper</a>.<a href="AsyncResultWrapper.cs.html#c2234ba9747d0ec7" class="i method">BeginSynchronous</a>(<span class="r93 r">callback</span>, <span class="r94 r">state</span>, <span class="r95 r">endInvokeFunc</span>, <span class="r98 r">endInvokeState</span>, <a href="#73719a88d885164e" class="i field">_invokeActionMethodTag</a>);
        }
 
        <b>public virtual bool</b> <a id="7d1db2911185004f" href="../R/7d1db2911185004f.html" target="n" data-glyph="72,1" class="i method">EndInvokeAction</a>(<a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <span id="r99 rd" class="r99 r">asyncResult</span>)
        {
            <b>return</b> <a href="AsyncResultWrapper.cs.html#ce8fa429970377d1" class="t t">AsyncResultWrapper</a>.<a href="AsyncResultWrapper.cs.html#54f6470c1b62a3df" class="i method">End</a>&lt;<b>bool</b>&gt;(<span class="r99 r">asyncResult</span>, <a href="#a0a6de1694966122" class="i field">_invokeActionTag</a>);
        }
 
        <b>protected internal virtual</b> <a href="../ActionResult.cs.html#8bbb8ceda32fbb12" class="t t">ActionResult</a> <a id="06e7a0dfcd99522d" href="../R/06e7a0dfcd99522d.html" target="n" data-glyph="75,1" class="i method">EndInvokeActionMethod</a>(<a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <span id="r100 rd" class="r100 r">asyncResult</span>)
        {
            <b>return</b> <a href="AsyncResultWrapper.cs.html#ce8fa429970377d1" class="t t">AsyncResultWrapper</a>.<a href="AsyncResultWrapper.cs.html#54f6470c1b62a3df" class="i method">End</a>&lt;<a href="../ActionResult.cs.html#8bbb8ceda32fbb12" class="t t">ActionResult</a>&gt;(<span class="r100 r">asyncResult</span>, <a href="#73719a88d885164e" class="i field">_invokeActionMethodTag</a>);
        }
 
        <b>protected internal virtual</b> <a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a> <a id="0111401514ea563e" href="../R/0111401514ea563e.html" target="n" data-glyph="75,1" class="i method">EndInvokeActionMethodWithFilters</a>(<a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <span id="r101 rd" class="r101 r">asyncResult</span>)
        {
            <b>return</b> <a href="AsyncResultWrapper.cs.html#ce8fa429970377d1" class="t t">AsyncResultWrapper</a>.<a href="AsyncResultWrapper.cs.html#54f6470c1b62a3df" class="i method">End</a>&lt;<a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a>&gt;(<span class="r101 r">asyncResult</span>, <a href="#1c64bfa8e7db57e2" class="i field">_invokeActionMethodWithFiltersTag</a>);
        }
 
        <b>protected override</b> <a href="../ControllerDescriptor.cs.html#20202e8261f37923" class="t t">ControllerDescriptor</a> <a id="bac5f0fefcdcc18b" href="../R/bac5f0fefcdcc18b.html" target="n" data-glyph="75,1" class="i method">GetControllerDescriptor</a>(<a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r102 rd" class="r102 r">controllerContext</span>)
        {
            <span class="c">// Frequently called, so ensure delegate is static</span>
            <a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a> <span id="r103 rd" class="r103 r">controllerType</span> = <span class="r102 r">controllerContext</span>.<a href="../ControllerContext.cs.html#722f9acba70af924" class="i property">Controller</a>.<a href="@0@mscorlib/A.html#4d73eb225aef8a61" class="i method">GetType</a>();
            <a href="../ControllerDescriptor.cs.html#20202e8261f37923" class="t t">ControllerDescriptor</a> <span id="r104 rd" class="r104 r">controllerDescriptor</span> = <a href="../ControllerActionInvoker.cs.html#65ede7451978affb" class="i property">DescriptorCache</a>.<a href="../ControllerDescriptorCache.cs.html#c24ea296c99b18b2" class="i method">GetDescriptor</a>(
                <span class="r105 r">controllerType</span>: <span class="r103 r">controllerType</span>,
                <span class="r106 r">creator</span>: <a href="ReflectedAsyncControllerDescriptor.cs.html#cfe211030a8b5f76" class="t t">ReflectedAsyncControllerDescriptor</a>.<a href="ReflectedAsyncControllerDescriptor.cs.html#a7f2ddffb5810a11" class="i field">DefaultDescriptorFactory</a>,
                <span class="r107 r">state</span>: <span class="r103 r">controllerType</span>);
            <b>return</b> <span class="r104 r">controllerDescriptor</span>;
        }
 
        <span class="c">// Keep as value type to avoid per-call allocation</span>
        <b>private struct</b> <a id="6e8a72a3d4ad3a98" href="../R/6e8a72a3d4ad3a98.html" target="n" data-glyph="112,1" class="t t"><span id="7686b8f4121e2087">ActionInvocation</span></a>
        {
            <b>private readonly</b> <a href="#cf5963931509b82c" class="t t">AsyncControllerActionInvoker</a> <a id="43f1b225c7744b8e" href="../R/43f1b225c7744b8e.html" target="n" data-glyph="46,2" class="i field">_invoker</a>;
            <b>private readonly</b> <a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <a id="b9f172c1341f7e8c" href="../R/b9f172c1341f7e8c.html" target="n" data-glyph="46,2" class="i field">_controllerContext</a>;
            <b>private readonly</b> <a href="../ActionDescriptor.cs.html#dcef6bdd6f885ebe" class="t t">ActionDescriptor</a> <a id="5f767725d949c3bc" href="../R/5f767725d949c3bc.html" target="n" data-glyph="46,2" class="i field">_actionDescriptor</a>;
            <b>private readonly</b> <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<b>string</b>, <b>object</b>&gt; <a id="465a70ce2ca1d437" href="../R/465a70ce2ca1d437.html" target="n" data-glyph="46,2" class="i field">_parameters</a>;
 
            <b>internal</b> <a id="92110b7b29f2307f" href="../R/92110b7b29f2307f.html" target="n" data-glyph="74,2" class="i constructor">ActionInvocation</a>(<a href="#cf5963931509b82c" class="t t">AsyncControllerActionInvoker</a> <span id="r108 rd" class="r108 r">invoker</span>, <a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r109 rd" class="r109 r">controllerContext</span>, <a href="../ActionDescriptor.cs.html#dcef6bdd6f885ebe" class="t t">ActionDescriptor</a> <span id="r110 rd" class="r110 r">actionDescriptor</span>, <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<b>string</b>, <b>object</b>&gt; <span id="r111 rd" class="r111 r">parameters</span>)
            {
                <a href="@0@mscorlib/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@0@mscorlib/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r108 r">invoker</span> != <b>null</b>);
                <a href="@0@mscorlib/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@0@mscorlib/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r109 r">controllerContext</span> != <b>null</b>);
                <a href="@0@mscorlib/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@0@mscorlib/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r110 r">actionDescriptor</span> != <b>null</b>);
                <a href="@0@mscorlib/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@0@mscorlib/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r111 r">parameters</span> != <b>null</b>);
 
                <a href="#43f1b225c7744b8e" class="i field">_invoker</a> = <span class="r108 r">invoker</span>;
                <a href="#b9f172c1341f7e8c" class="i field">_controllerContext</a> = <span class="r109 r">controllerContext</span>;
                <a href="#5f767725d949c3bc" class="i field">_actionDescriptor</a> = <span class="r110 r">actionDescriptor</span>;
                <a href="#465a70ce2ca1d437" class="i field">_parameters</a> = <span class="r111 r">parameters</span>;
            }
 
            <b>internal</b> <a href="../ActionResult.cs.html#8bbb8ceda32fbb12" class="t t">ActionResult</a> <a id="a42648f5c486b429" href="../R/a42648f5c486b429.html" target="n" data-glyph="74,2" class="i method">InvokeSynchronousActionMethod</a>()
            {
                <b>return</b> <a href="#43f1b225c7744b8e" class="i field">_invoker</a>.<a href="../ControllerActionInvoker.cs.html#0aa3cfdbfc7a54df" class="i method">InvokeActionMethod</a>(<a href="#b9f172c1341f7e8c" class="i field">_controllerContext</a>, <a href="#5f767725d949c3bc" class="i field">_actionDescriptor</a>, <a href="#465a70ce2ca1d437" class="i field">_parameters</a>);
            }
        }
 
        <span class="c">// Large and passed to many function calls, so keep as a reference type to minimize copying</span>
        <b>private class</b> <a id="364eef058aebec55" href="../R/364eef058aebec55.html" target="n" data-glyph="4,1" class="t t">AsyncInvocationWithFilters</a>
        {
            <b>private readonly</b> <a href="#cf5963931509b82c" class="t t">AsyncControllerActionInvoker</a> <a id="22d20fcc07cd12f7" href="../R/22d20fcc07cd12f7.html" target="n" data-glyph="46,2" class="i field">_invoker</a>;
            <b>private readonly</b> <a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <a id="61409a8b2505c1a2" href="../R/61409a8b2505c1a2.html" target="n" data-glyph="46,2" class="i field">_controllerContext</a>;
            <b>private readonly</b> <a href="../ActionDescriptor.cs.html#dcef6bdd6f885ebe" class="t t">ActionDescriptor</a> <a id="d7fc8f90d996645a" href="../R/d7fc8f90d996645a.html" target="n" data-glyph="46,2" class="i field">_actionDescriptor</a>;
            <b>private readonly</b> <a href="@0@mscorlib/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="../IActionFilter.cs.html#11570d9642b3eeee" class="t t">IActionFilter</a>&gt; <a id="1e0a22c39e3cf861" href="../R/1e0a22c39e3cf861.html" target="n" data-glyph="46,2" class="i field">_filters</a>;
            <b>private readonly</b> <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<b>string</b>, <b>object</b>&gt; <a id="bcb94f4538fa8e6e" href="../R/bcb94f4538fa8e6e.html" target="n" data-glyph="46,2" class="i field">_parameters</a>;
            <b>private readonly</b> <a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <a id="ea75f6c51eec9869" href="../R/ea75f6c51eec9869.html" target="n" data-glyph="46,2" class="i field">_asyncCallback</a>;
            <b>private readonly object</b> <a id="8daf84f30c9cd2d6" href="../R/8daf84f30c9cd2d6.html" target="n" data-glyph="46,2" class="i field">_asyncState</a>;
            <b>private readonly int</b> <a id="90be5a10b32cb245" href="../R/90be5a10b32cb245.html" target="n" data-glyph="46,2" class="i field">_filterCount</a>;
            <b>private readonly</b> <a href="../ActionExecutingContext.cs.html#39784fbc246122e1" class="t t">ActionExecutingContext</a> <a id="70d6edf375c816c3" href="../R/70d6edf375c816c3.html" target="n" data-glyph="46,2" class="i field">_preContext</a>;
 
            <b>internal</b> <a href="@0@mscorlib/A.html#71a3deb2ea37ce06" class="t t">IAsyncResult</a> <a id="802a9340ff44bb89" href="../R/802a9340ff44bb89.html" target="n" data-glyph="44,2" class="i field">InnerAsyncResult</a>;
 
            <b>internal</b> <a id="c9d261d7b955456d" href="../R/c9d261d7b955456d.html" target="n" data-glyph="74,2" class="i constructor">AsyncInvocationWithFilters</a>(<a href="#cf5963931509b82c" class="t t">AsyncControllerActionInvoker</a> <span id="r112 rd" class="r112 r">invoker</span>, <a href="../ControllerContext.cs.html#2d2ade91d6ccd6fe" class="t t">ControllerContext</a> <span id="r113 rd" class="r113 r">controllerContext</span>, <a href="../ActionDescriptor.cs.html#dcef6bdd6f885ebe" class="t t">ActionDescriptor</a> <span id="r114 rd" class="r114 r">actionDescriptor</span>, <a href="@0@mscorlib/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="../IActionFilter.cs.html#11570d9642b3eeee" class="t t">IActionFilter</a>&gt; <span id="r115 rd" class="r115 r">filters</span>, <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<b>string</b>, <b>object</b>&gt; <span id="r116 rd" class="r116 r">parameters</span>, <a href="@0@mscorlib/A.html#58aea74ca92df82e" class="t t">AsyncCallback</a> <span id="r117 rd" class="r117 r">asyncCallback</span>, <b>object</b> <span id="r118 rd" class="r118 r">asyncState</span>)
            {
                <a href="@0@mscorlib/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@0@mscorlib/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r112 r">invoker</span> != <b>null</b>);
                <a href="@0@mscorlib/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@0@mscorlib/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r113 r">controllerContext</span> != <b>null</b>);
                <a href="@0@mscorlib/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@0@mscorlib/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r114 r">actionDescriptor</span> != <b>null</b>);
                <a href="@0@mscorlib/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@0@mscorlib/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r115 r">filters</span> != <b>null</b>);
                <a href="@0@mscorlib/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@0@mscorlib/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r116 r">parameters</span> != <b>null</b>);
 
                <a href="#22d20fcc07cd12f7" class="i field">_invoker</a> = <span class="r112 r">invoker</span>;
                <a href="#61409a8b2505c1a2" class="i field">_controllerContext</a> = <span class="r113 r">controllerContext</span>;
                <a href="#d7fc8f90d996645a" class="i field">_actionDescriptor</a> = <span class="r114 r">actionDescriptor</span>;
                <a href="#1e0a22c39e3cf861" class="i field">_filters</a> = <span class="r115 r">filters</span>;
                <a href="#bcb94f4538fa8e6e" class="i field">_parameters</a> = <span class="r116 r">parameters</span>;
                <a href="#ea75f6c51eec9869" class="i field">_asyncCallback</a> = <span class="r117 r">asyncCallback</span>;
                <a href="#8daf84f30c9cd2d6" class="i field">_asyncState</a> = <span class="r118 r">asyncState</span>;
 
                <a href="#70d6edf375c816c3" class="i field">_preContext</a> = <b>new</b> <a href="../ActionExecutingContext.cs.html#16f88021bc4cf88c" class="t constructor">ActionExecutingContext</a>(<span class="r113 r">controllerContext</span>, <span class="r114 r">actionDescriptor</span>, <span class="r116 r">parameters</span>);
                <span class="c">// For IList&lt;T&gt; it is faster to cache the count</span>
                <a href="#90be5a10b32cb245" class="i field">_filterCount</a> = <a href="#1e0a22c39e3cf861" class="i field">_filters</a>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a>;
            }
 
            <b>internal</b> <a href="@0@mscorlib/A.html#87d60abb7092d5a4" class="t t">Func</a>&lt;<a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a>&gt; <a id="fde15367e8d5d8ba" href="../R/fde15367e8d5d8ba.html" target="n" data-glyph="74,2" class="i method">InvokeActionMethodFilterAsynchronouslyRecursive</a>(<b>int</b> <span id="r119 rd" class="r119 r">filterIndex</span>)
            {
                <span class="c">// Performance-sensitive</span>
 
                <span class="c">// For compatability, the following behavior must be maintained</span>
                <span class="c">//   The OnActionExecuting events must fire in forward order</span>
                <span class="c">//   The Begin and End events must fire</span>
                <span class="c">//   The OnActionExecuted events must fire in reverse order</span>
                <span class="c">//   Earlier filters can process the results and exceptions from the handling of later filters</span>
                <span class="c">// This is achieved by calling recursively and moving through the filter list forwards</span>
 
                <span class="c">// If there are no more filters to recurse over, create the main result</span>
                <b>if</b> (<span class="r119 r">filterIndex</span> &gt; <a href="#90be5a10b32cb245" class="i field">_filterCount</a> - 1)
                {
                    <a href="#802a9340ff44bb89" class="i field">InnerAsyncResult</a> = <a href="#22d20fcc07cd12f7" class="i field">_invoker</a>.<a href="#4ac5de6d8d3e1383" class="i method">BeginInvokeActionMethod</a>(<a href="#61409a8b2505c1a2" class="i field">_controllerContext</a>, <a href="#d7fc8f90d996645a" class="i field">_actionDescriptor</a>, <a href="#bcb94f4538fa8e6e" class="i field">_parameters</a>, <a href="#ea75f6c51eec9869" class="i field">_asyncCallback</a>, <a href="#8daf84f30c9cd2d6" class="i field">_asyncState</a>);
                    <b>return</b> () =&gt;
                           <b>new</b> <a href="../ActionExecutedContext.cs.html#9729e48f062bf141" class="t constructor">ActionExecutedContext</a>(<a href="#61409a8b2505c1a2" class="i field">_controllerContext</a>, <a href="#d7fc8f90d996645a" class="i field">_actionDescriptor</a>, <span class="r120 r">canceled</span>: <b>false</b>, <span class="r121 r">exception</span>: <b>null</b>)
                           {
                               <a href="../ActionExecutedContext.cs.html#26fe45b16618eee9" class="i property">Result</a> = <a href="#22d20fcc07cd12f7" class="i field">_invoker</a>.<a href="#06e7a0dfcd99522d" class="i method">EndInvokeActionMethod</a>(<a href="#802a9340ff44bb89" class="i field">InnerAsyncResult</a>)
                           };
                }
 
                <span class="c">// Otherwise process the filters recursively</span>
                <a href="../IActionFilter.cs.html#11570d9642b3eeee" class="t t">IActionFilter</a> <span id="r122 rd" class="r122 r">filter</span> = <a href="#1e0a22c39e3cf861" class="i field">_filters</a><a href="@0@mscorlib/A.html#396bb785d31f5979">[</a><span class="r119 r">filterIndex</span>];
                <a href="../ActionExecutingContext.cs.html#39784fbc246122e1" class="t t">ActionExecutingContext</a> <span id="r123 rd" class="r123 r">preContext</span> = <a href="#70d6edf375c816c3" class="i field">_preContext</a>;
                <span class="r122 r">filter</span>.<a href="../IActionFilter.cs.html#1caf69887439b837" class="i method">OnActionExecuting</a>(<span class="r123 r">preContext</span>);
                <b>if</b> (<span class="r123 r">preContext</span>.<a href="../ActionExecutingContext.cs.html#0f2a66fe5c3a5fee" class="i property">Result</a> != <b>null</b>)
                {
                    <a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a> <span id="r124 rd" class="r124 r">shortCircuitedPostContext</span> = <b>new</b> <a href="../ActionExecutedContext.cs.html#9729e48f062bf141" class="t constructor">ActionExecutedContext</a>(<span class="r123 r">preContext</span>, <span class="r123 r">preContext</span>.<a href="../ActionExecutingContext.cs.html#336cfe2229573afd" class="i property">ActionDescriptor</a>, <span class="r120 r">canceled</span>: <b>true</b>, <span class="r121 r">exception</span>: <b>null</b>)
                    {
                        <a href="../ActionExecutedContext.cs.html#26fe45b16618eee9" class="i property">Result</a> = <span class="r123 r">preContext</span>.<a href="../ActionExecutingContext.cs.html#0f2a66fe5c3a5fee" class="i property">Result</a>
                    };
                    <b>return</b> () =&gt; <span class="r124 r">shortCircuitedPostContext</span>;
                }
 
                <span class="c">// There is a nested try / catch block here that contains much the same logic as the outer block.</span>
                <span class="c">// Since an exception can occur on either side of the asynchronous invocation, we need guards on</span>
                <span class="c">// on both sides. In the code below, the second side is represented by the nested delegate. This</span>
                <span class="c">// is really just a parallel of the synchronous ControllerActionInvoker.InvokeActionMethodFilter()</span>
                <span class="c">// method.</span>
 
                <b>try</b>
                {
                    <span class="c">// Use the filters in forward direction</span>
                    <b>int</b> <span id="r125 rd" class="r125 r">nextFilterIndex</span> = <span class="r119 r">filterIndex</span> + 1;
                    <a href="@0@mscorlib/A.html#87d60abb7092d5a4" class="t t">Func</a>&lt;<a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a>&gt; <span id="r126 rd" class="r126 r">continuation</span> = <a href="#fde15367e8d5d8ba" class="i method">InvokeActionMethodFilterAsynchronouslyRecursive</a>(<span class="r125 r">nextFilterIndex</span>);
 
                    <span class="c">// add our own continuation, then return the new function</span>
                    <b>return</b> () =&gt;
                    {
                        <a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a> <span id="r127 rd" class="r127 r">postContext</span>;
                        <b>bool</b> <span id="r128 rd" class="r128 r">wasError</span> = <b>true</b>;
 
                        <b>try</b>
                        {
                            <span class="r127 r">postContext</span> = <span class="r126 r">continuation</span>();
                            <span class="r128 r">wasError</span> = <b>false</b>;
                        }
                        <b>catch</b> (<a href="@0@mscorlib/A.html#1b47a5a85e0d5883" class="t t">ThreadAbortException</a>)
                        {
                            <span class="c">// This type of exception occurs as a result of Response.Redirect(), but we special-case so that</span>
                            <span class="c">// the filters don&#39;t see this as an error.</span>
                            <span class="r127 r">postContext</span> = <b>new</b> <a href="../ActionExecutedContext.cs.html#9729e48f062bf141" class="t constructor">ActionExecutedContext</a>(<span class="r123 r">preContext</span>, <span class="r123 r">preContext</span>.<a href="../ActionExecutingContext.cs.html#336cfe2229573afd" class="i property">ActionDescriptor</a>, <span class="r120 r">canceled</span>: <b>false</b>, <span class="r121 r">exception</span>: <b>null</b>);
                            <span class="r122 r">filter</span>.<a href="../IActionFilter.cs.html#06ddaff3f668d0fc" class="i method">OnActionExecuted</a>(<span class="r127 r">postContext</span>);
                            <b>throw</b>;
                        }
                        <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r129 rd" class="r129 r">ex</span>)
                        {
                            <span class="r127 r">postContext</span> = <b>new</b> <a href="../ActionExecutedContext.cs.html#9729e48f062bf141" class="t constructor">ActionExecutedContext</a>(<span class="r123 r">preContext</span>, <span class="r123 r">preContext</span>.<a href="../ActionExecutingContext.cs.html#336cfe2229573afd" class="i property">ActionDescriptor</a>, <span class="r120 r">canceled</span>: <b>false</b>, <span class="r121 r">exception</span>: <span class="r129 r">ex</span>);
                            <span class="r122 r">filter</span>.<a href="../IActionFilter.cs.html#06ddaff3f668d0fc" class="i method">OnActionExecuted</a>(<span class="r127 r">postContext</span>);
                            <b>if</b> (!<span class="r127 r">postContext</span>.<a href="../ActionExecutedContext.cs.html#793e68ee99ffb3b3" class="i property">ExceptionHandled</a>)
                            {
                                <b>throw</b>;
                            }
                        }
                        <b>if</b> (!<span class="r128 r">wasError</span>)
                        {
                            <span class="r122 r">filter</span>.<a href="../IActionFilter.cs.html#06ddaff3f668d0fc" class="i method">OnActionExecuted</a>(<span class="r127 r">postContext</span>);
                        }
 
                        <b>return</b> <span class="r127 r">postContext</span>;
                    };
                }
                <b>catch</b> (<a href="@0@mscorlib/A.html#1b47a5a85e0d5883" class="t t">ThreadAbortException</a>)
                {
                    <span class="c">// This type of exception occurs as a result of Response.Redirect(), but we special-case so that</span>
                    <span class="c">// the filters don&#39;t see this as an error.</span>
                    <a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a> <span id="r130 rd" class="r130 r">postContext</span> = <b>new</b> <a href="../ActionExecutedContext.cs.html#9729e48f062bf141" class="t constructor">ActionExecutedContext</a>(<span class="r123 r">preContext</span>, <span class="r123 r">preContext</span>.<a href="../ActionExecutingContext.cs.html#336cfe2229573afd" class="i property">ActionDescriptor</a>, <span class="r120 r">canceled</span>: <b>false</b>, <span class="r121 r">exception</span>: <b>null</b>);
                    <span class="r122 r">filter</span>.<a href="../IActionFilter.cs.html#06ddaff3f668d0fc" class="i method">OnActionExecuted</a>(<span class="r130 r">postContext</span>);
                    <b>throw</b>;
                }
                <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r131 rd" class="r131 r">ex</span>)
                {
                    <a href="../ActionExecutedContext.cs.html#702e1e1833b63b7b" class="t t">ActionExecutedContext</a> <span id="r132 rd" class="r132 r">postContext</span> = <b>new</b> <a href="../ActionExecutedContext.cs.html#9729e48f062bf141" class="t constructor">ActionExecutedContext</a>(<span class="r123 r">preContext</span>, <span class="r123 r">preContext</span>.<a href="../ActionExecutingContext.cs.html#336cfe2229573afd" class="i property">ActionDescriptor</a>, <span class="r120 r">canceled</span>: <b>false</b>, <span class="r121 r">exception</span>: <span class="r131 r">ex</span>);
                    <span class="r122 r">filter</span>.<a href="../IActionFilter.cs.html#06ddaff3f668d0fc" class="i method">OnActionExecuted</a>(<span class="r132 r">postContext</span>);
                    <b>if</b> (<span class="r132 r">postContext</span>.<a href="../ActionExecutedContext.cs.html#793e68ee99ffb3b3" class="i property">ExceptionHandled</a>)
                    {
                        <b>return</b> () =&gt; <span class="r132 r">postContext</span>;
                    }
                    <b>else</b>
                    {
                        <b>throw</b>;
                    }
                }
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
